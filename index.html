<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSE</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e7eef7; }
    .row { display:flex; gap:16px; padding:16px; }
    .card { background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:16px; width: 420px; }
    .badge { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    .dot { width:10px; height:10px; border-radius:50%; background:#ff4d4d; }
    .dot.ok { background:#2ee59d; }
    button { appearance:none; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#e7eef7; padding:10px 12px; border-radius:12px; cursor:pointer; }
    input, select, textarea { width:100%; margin-top:8px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#e7eef7; }
    .err { color:#ff6b6b; white-space:pre-wrap; margin-top:8px; font-size:13px; }
    .ok { color:#2ee59d; white-space:pre-wrap; margin-top:8px; font-size:13px; }
    .grow { flex:1; }
  </style>
</head>
<body>

<div class="row" style="align-items:center; justify-content:space-between;">
  <div class="badge">
    <div id="dot" class="dot"></div>
    <div id="apiText">API: checking…</div>
  </div>
  <div style="display:flex; gap:10px;">
    <button id="openApiBtn" type="button">Open API</button>
    <button id="checkBtn" type="button">Check API</button>
    <button id="refreshBtn" type="button">Refresh</button>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3 style="margin:0 0 12px 0;">Upload video</h3>

    <label>Video file</label>
    <input id="file" type="file" accept="video/*" />

    <label>Title</label>
    <input id="title" placeholder="e.g., NQ Scalps — Jan 4" />

    <label>Owner</label>
    <select id="owner">
      <option value="">(none)</option>
      <option value="Aiden">Aiden</option>
      <option value="Landon">Landon</option>
    </select>

    <label>Sort tag</label>
    <input id="tag" placeholder="Trade Review / Setups / etc" />

    <label>Description Q1</label>
    <input id="q1" placeholder="What was the setup?" />

    <label>Description Q2</label>
    <input id="q2" placeholder="What did you learn?" />

    <label>Notes (optional)</label>
    <textarea id="notes" rows="4" placeholder="Write notes attached to this video…"></textarea>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button id="uploadBtn" type="button">Upload</button>
      <button id="clearBtn" type="button">Clear</button>
    </div>

    <div id="uploadMsg" class="err"></div>
  </div>

  <div class="card grow">
    <h3 style="margin:0 0 12px 0;">Videos</h3>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="loadBtn" type="button">Load</button>
    </div>
    <div id="listMsg" class="err"></div>
    <div id="list" style="margin-top:10px;"></div>
  </div>
</div>

<script>
  // IMPORTANT: Always hit the API subdomain to avoid Pages/GitHub routing conflicts.
  const API_BASE = "https://api.tseapp.com";

  const dot = document.getElementById("dot");
  const apiText = document.getElementById("apiText");
  const uploadMsg = document.getElementById("uploadMsg");
  const listMsg = document.getElementById("listMsg");
  const list = document.getElementById("list");

  document.getElementById("openApiBtn").onclick = () => window.open(`${API_BASE}/api/health`, "_blank");
  document.getElementById("checkBtn").onclick = () => checkApi();
  document.getElementById("refreshBtn").onclick = () => location.reload();

  document.getElementById("loadBtn").onclick = () => loadVideos();
  document.getElementById("uploadBtn").onclick = () => upload();
  document.getElementById("clearBtn").onclick = () => {
    ["file","title","tag","q1","q2","notes"].forEach(id => {
      const el = document.getElementById(id);
      if (el.type === "file") el.value = "";
      else el.value = "";
    });
    document.getElementById("owner").value = "";
    uploadMsg.textContent = "";
  };

  function setApiStatus(ok, detail="") {
    dot.classList.toggle("ok", !!ok);
    apiText.textContent = ok ? "API: online" : `API: offline${detail ? " ("+detail+")" : ""}`;
  }

  async function safeJson(response) {
    // Never assume JSON — read text first so we can show real errors.
    const text = await response.text();
    try {
      return { ok: true, data: JSON.parse(text), raw: text };
    } catch {
      return { ok: false, data: null, raw: text };
    }
  }

  async function checkApi() {
    setApiStatus(false, "checking…");
    try {
      const res = await fetch(`${API_BASE}/api/health`, { method: "GET" });
      const parsed = await safeJson(res);
      if (!res.ok) {
        setApiStatus(false, `HTTP ${res.status}`);
        return;
      }
      if (parsed.ok && parsed.data && parsed.data.ok === true) {
        setApiStatus(true);
      } else {
        setApiStatus(false, "bad JSON");
      }
    } catch (e) {
      setApiStatus(false, "network/CORS");
    }
  }

  async function loadVideos() {
    listMsg.textContent = "";
    list.textContent = "";
    await checkApi();

    try {
      const res = await fetch(`${API_BASE}/api/videos`, { method: "GET" });
      const parsed = await safeJson(res);

      if (!res.ok) {
        listMsg.textContent = `Load failed: HTTP ${res.status}\n${parsed.raw}`;
        return;
      }
      if (!parsed.ok) {
        listMsg.textContent = `Load failed: Non-JSON response\n${parsed.raw}`;
        return;
      }

      const videos = parsed.data.videos || [];
      if (!videos.length) {
        list.textContent = "0 items";
        return;
      }

      for (const v of videos) {
        const el = document.createElement("div");
        el.style.padding = "10px";
        el.style.border = "1px solid rgba(255,255,255,.10)";
        el.style.borderRadius = "12px";
        el.style.marginBottom = "10px";
        el.textContent = `${v.title || "(untitled)"} — ${v.owner || "?"} — ${new Date(v.createdAt || Date.now()).toLocaleString()}`;
        list.appendChild(el);
      }
    } catch (e) {
      listMsg.textContent = `Load failed (network/CORS): ${e?.message || e}`;
    }
  }

  async function upload() {
    uploadMsg.textContent = "";
    await checkApi();

    const file = document.getElementById("file").files[0];
    if (!file) {
      uploadMsg.textContent = "Pick a video file first.";
      return;
    }

    const fd = new FormData();
    fd.append("file", file);
    fd.append("title", document.getElementById("title").value || "");
    fd.append("owner", document.getElementById("owner").value || "");
    fd.append("tag", document.getElementById("tag").value || "");
    fd.append("q1", document.getElementById("q1").value || "");
    fd.append("q2", document.getElementById("q2").value || "");
    fd.append("notes", document.getElementById("notes").value || "");

    try {
      const res = await fetch(`${API_BASE}/api/videos`, { method: "POST", body: fd });
      const parsed = await safeJson(res);

      if (!res.ok) {
        uploadMsg.textContent = `Upload failed: HTTP ${res.status}\n${parsed.raw}`;
        return;
      }
      if (!parsed.ok) {
        uploadMsg.textContent = `Upload failed: Non-JSON response\n${parsed.raw}`;
        return;
      }

      uploadMsg.className = "ok";
      uploadMsg.textContent = "Upload complete ✅";
      await loadVideos();
    } catch (e) {
      uploadMsg.className = "err";
      uploadMsg.textContent = `Upload failed (network/CORS): ${e?.message || e}`;
    }
  }

  // boot
  (async () => {
    await checkApi();
  })();
</script>

</body>
</html>
