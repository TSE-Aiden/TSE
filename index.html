<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TSE</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --text:#e7eef7;
      --muted:#9db0c6;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --accent:#6ee7ff;
      --accent2:#7c3aed;
      --good:#22c55e;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(110,231,255,.12), transparent 55%),
        linear-gradient(180deg, #06090d 0%, var(--bg) 100%);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;align-items:center;gap:12px;
      font-weight:800;letter-spacing:.5px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.9), rgba(124,58,237,.9));
      box-shadow: 0 12px 35px rgba(124,58,237,.25);
    }
    .brand small{display:block;color:var(--muted);font-weight:600;letter-spacing:0}
    .actions{display:flex;gap:10px;align-items:center}
    button,.btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover,.btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.14)}
    button:active,.btn:active{transform: translateY(1px)}
    .btn-primary{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(124,58,237,.14));
    }
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      background:rgba(0,0,0,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      margin-top:18px;
    }
    .sidebar,.panel{
      border:1px solid var(--border);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .sidebar{padding:14px}
    .nav{
      display:flex;flex-direction:column;gap:8px;
    }
    .nav button{
      width:100%;
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;border-radius:14px;
      background:rgba(0,0,0,.12);
    }
    .nav button.active{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(180deg, rgba(110,231,255,.15), rgba(124,58,237,.12));
    }

    .content{padding:16px}
    .panel-header{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      padding:16px 16px 0 16px;
    }
    .panel-header h2{margin:0;font-size:18px}
    .panel-header p{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .panel-body{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{
      display:flex;flex-direction:column;gap:6px;
      min-width: 180px;
      flex:1;
    }
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    .split{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.12);
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
      position:relative;
      overflow:hidden;
    }
    .card:hover{transform: translateY(-2px);border-color:rgba(110,231,255,.28);background:rgba(0,0,0,.16)}
    .card h3{margin:0 0 6px 0;font-size:14px}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
    .card .desc{margin:10px 0 0 0;color:rgba(231,238,247,.85);font-size:13px;line-height:1.35}
    .card .footer{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:10px;
    }
    .tag{
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
    }
    .tag.accent{border-color:rgba(110,231,255,.28)}
    .mini{
      display:flex;gap:8px;align-items:center;
    }
    .mini button{padding:8px 10px;border-radius:12px}
    video{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background: #000;
      display:none;
      margin-top:10px;
    }
    .card:hover video{
      display:block; /* hover preview */
    }

    /* Notes editor */
    .editor-shell{
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .tool{
      padding:8px 10px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-size:12px;
    }
    .tool:hover{background: rgba(255,255,255,.08)}
    .editor{
      min-height:420px;
      padding:14px 16px;
      outline:none;
      line-height:1.55;
    }
    .editor img{
      max-width:100%;
      height:auto;
      border-radius:12px;
      border:1px solid var(--border);
      display:block;
      margin:10px 0;
    }

    /* Auth overlay */
    .overlay{
      position:fixed;inset:0;
      display:flex;align-items:center;justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      z-index:999;
    }
    .auth{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding:18px;
    }
    .auth h1{margin:0 0 6px 0;font-size:20px}
    .auth p{margin:0 0 14px 0;color:var(--muted);font-size:13px;line-height:1.35}
    .auth .row{gap:10px}
    .error{color: #fecaca; font-size:12px; margin-top:10px; display:none}
    .success{color: #bbf7d0; font-size:12px; margin-top:10px; display:none}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="overlay" style="display:none">
    <div class="auth">
      <h1>TSE Access</h1>
      <p>Enter the site password to continue.</p>

      <div class="row">
        <div class="field" style="min-width:240px">
          <label for="pw">Password</label>
          <input id="pw" type="password" placeholder="Enter password..." autocomplete="current-password" />
          <div class="hint">Prototype gate (client-side). For real protection, use server-side auth.</div>
        </div>
        <div class="field" style="min-width:160px;align-self:flex-end">
          <button class="btn-primary" id="loginBtn">Unlock</button>
        </div>
      </div>

      <div class="error" id="authError">Incorrect password.</div>
      <div class="success" id="authOk">Unlocked.</div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

      <div class="row">
        <div class="field">
          <label>Admin: change password (local to this browser)</label>
          <input id="newPw" type="password" placeholder="New password..." />
        </div>
        <div class="field" style="align-self:flex-end;min-width:160px">
          <button id="setPwBtn">Set Password</button>
        </div>
      </div>
      <div class="hint">Tip: set it once, then share the same browser/profile if you want quick access.</div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="font-size:18px">TSE</div>
          <small>Videos + Notes (private prototype)</small>
        </div>
      </div>
      <div class="actions">
        <span class="pill" id="statusPill">Local mode</span>
        <button id="exportBtn">Export Data</button>
        <button id="clearBtn">Clear Local Data</button>
        <button id="lockBtn">Lock</button>
      </div>
    </div>

    <div class="grid">
      <div class="sidebar">
        <div class="nav">
          <button class="active" id="tabVideos">
            <span>üé¨ Videos</span>
            <span class="pill" id="videoCount">0</span>
          </button>
          <button id="tabNotes">
            <span>üìù Notes</span>
            <span class="pill" id="notesPill">Doc</span>
          </button>
        </div>

        <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
          <div class="hint">
            Hover a video card to preview.<br/>
            Notes autosave to this device.
          </div>
        </div>
      </div>

      <div class="panel">
        <!-- VIDEOS VIEW -->
        <div id="videosView">
          <div class="panel-header">
            <div>
              <h2>Videos</h2>
              <p>Upload a video, answer the description questions (including <b>Aiden or Landon</b>), then manage your library.</p>
            </div>
          </div>

          <div class="panel-body">
            <div class="split">
              <div>
                <div class="row">
                  <div class="field" style="min-width:100%">
                    <label for="videoFile">Video file</label>
                    <input id="videoFile" type="file" accept="video/*" />
                    <div class="hint">Stored as a local file reference (not uploaded anywhere in this prototype).</div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div class="field">
                    <label for="videoTitle">Title</label>
                    <input id="videoTitle" placeholder="Ex: SPY scalp review" />
                  </div>
                  <div class="field">
                    <label for="videoOwner">Aiden or Landon</label>
                    <select id="videoOwner">
                      <option value="" selected disabled>Choose...</option>
                      <option value="Aiden">Aiden</option>
                      <option value="Landon">Landon</option>
                    </select>
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div class="field">
                    <label for="videoQ1">Description Q1</label>
                    <input id="videoQ1" placeholder="What was the setup?" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div class="field">
                    <label for="videoQ2">Description Q2</label>
                    <input id="videoQ2" placeholder="What was the mistake / lesson?" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div class="field" style="min-width:100%">
                    <label for="videoDesc">Notes / extra details</label>
                    <textarea id="videoDesc" placeholder="Write any additional context..."></textarea>
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <button class="btn-primary" id="addVideoBtn">Add Video</button>
                  <div class="hint" id="videoFormHint" style="align-self:center"></div>
                </div>
              </div>

              <div>
                <div class="hint">Library</div>
                <div class="cards" id="videoCards"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- NOTES VIEW -->
        <div id="notesView" style="display:none">
          <div class="panel-header">
            <div>
              <h2>Notes</h2>
              <p>A lightweight Google-Doc style editor. Supports formatting + inserting images into the doc.</p>
            </div>
          </div>

          <div class="panel-body">
            <div class="row" style="margin-bottom:10px">
              <div class="field" style="min-width:260px;flex:0">
                <label for="docTitle">Document title</label>
                <input id="docTitle" placeholder="TSE Notes" />
              </div>
              <div class="field" style="align-self:flex-end;flex:1">
                <div class="hint" id="saveStatus">Autosave: idle</div>
              </div>
              <div class="field" style="align-self:flex-end;flex:0;min-width:220px">
                <input id="imageInsert" type="file" accept="image/*" />
              </div>
              <div class="field" style="align-self:flex-end;flex:0;min-width:140px">
                <button id="downloadHtmlBtn">Download Doc</button>
              </div>
            </div>

            <div class="editor-shell">
              <div class="toolbar">
                <button class="tool" data-cmd="bold"><b>B</b></button>
                <button class="tool" data-cmd="italic"><i>I</i></button>
                <button class="tool" data-cmd="underline"><u>U</u></button>
                <button class="tool" data-cmd="insertUnorderedList">‚Ä¢ List</button>
                <button class="tool" data-cmd="insertOrderedList">1. List</button>
                <button class="tool" id="h2Btn">H2</button>
                <button class="tool" id="quoteBtn">Quote</button>
                <button class="tool" id="linkBtn">Link</button>
                <button class="tool" id="clearFormatBtn">Clear</button>
                <span class="pill">Tip: you can also paste images</span>
              </div>
              <div id="editor" class="editor" contenteditable="true" spellcheck="true"></div>
            </div>

            <div class="hint" style="margin-top:10px">
              Images are embedded into the doc (base64). This is stored locally in your browser.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * TSE Prototype
 * - Client-side password gate (NOT true security)
 * - Videos: upload list + hover preview
 * - Notes: contenteditable doc with image insert + autosave
 */

// ---------- Basic storage keys ----------
const KEY_AUTH = "tse_auth_ok";
const KEY_PW = "tse_password";
const KEY_VIDEOS = "tse_videos";
const KEY_DOC = "tse_doc";

// ---------- Password gate ----------
const DEFAULT_PASSWORD = "tse123"; // change this after first run
function getPassword() {
  return localStorage.getItem(KEY_PW) || DEFAULT_PASSWORD;
}
function setPassword(pw) {
  localStorage.setItem(KEY_PW, pw);
}
function isAuthed() {
  return localStorage.getItem(KEY_AUTH) === "true";
}
function setAuthed(v) {
  localStorage.setItem(KEY_AUTH, v ? "true" : "false");
}

// ---------- App elements ----------
const authOverlay = document.getElementById("authOverlay");
const app = document.getElementById("app");

const pwInput = document.getElementById("pw");
const loginBtn = document.getElementById("loginBtn");
const authError = document.getElementById("authError");
const authOk = document.getElementById("authOk");
const newPw = document.getElementById("newPw");
const setPwBtn = document.getElementById("setPwBtn");

const lockBtn = document.getElementById("lockBtn");
const clearBtn = document.getElementById("clearBtn");
const exportBtn = document.getElementById("exportBtn");

// Tabs
const tabVideos = document.getElementById("tabVideos");
const tabNotes = document.getElementById("tabNotes");
const videosView = document.getElementById("videosView");
const notesView = document.getElementById("notesView");

// Videos form
const videoFile = document.getElementById("videoFile");
const videoTitle = document.getElementById("videoTitle");
const videoOwner = document.getElementById("videoOwner");
const videoQ1 = document.getElementById("videoQ1");
const videoQ2 = document.getElementById("videoQ2");
const videoDesc = document.getElementById("videoDesc");
const addVideoBtn = document.getElementById("addVideoBtn");
const videoCards = document.getElementById("videoCards");
const videoCount = document.getElementById("videoCount");
const videoFormHint = document.getElementById("videoFormHint");

// Notes editor
const docTitle = document.getElementById("docTitle");
const editor = document.getElementById("editor");
const saveStatus = document.getElementById("saveStatus");
const imageInsert = document.getElementById("imageInsert");
const downloadHtmlBtn = document.getElementById("downloadHtmlBtn");

// ---------- Init ----------
function showAuth() {
  authOverlay.style.display = "flex";
  app.style.display = "none";
  authError.style.display = "none";
  authOk.style.display = "none";
  pwInput.value = "";
  pwInput.focus();
}
function showApp() {
  authOverlay.style.display = "none";
  app.style.display = "block";
}
function boot() {
  authOverlay.style.display = "none";
  app.style.display = "none";
  if (isAuthed()) showApp();
  else showAuth();

  loadVideos();
  renderVideos();
  loadDoc();
  setTab("videos");
}
boot();

// ---------- Auth events ----------
function attemptLogin() {
  authError.style.display = "none";
  authOk.style.display = "none";

  const input = (pwInput.value || "").trim();
  if (input && input === getPassword()) {
    setAuthed(true);
    authOk.style.display = "block";
    showApp();
  } else {
    authError.style.display = "block";
  }
}
loginBtn.addEventListener("click", attemptLogin);
pwInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") attemptLogin();
});

setPwBtn.addEventListener("click", () => {
  const np = (newPw.value || "").trim();
  if (!np) return;
  setPassword(np);
  newPw.value = "";
  // small confirmation
  authOk.textContent = "Password updated (local to this browser).";
  authOk.style.display = "block";
  authError.style.display = "none";
});

// Lock
lockBtn.addEventListener("click", () => {
  setAuthed(false);
  showAuth();
});

// ---------- Tabs ----------
function setTab(tab) {
  const isVideos = tab === "videos";
  tabVideos.classList.toggle("active", isVideos);
  tabNotes.classList.toggle("active", !isVideos);
  videosView.style.display = isVideos ? "block" : "none";
  notesView.style.display = !isVideos ? "block" : "none";
}
tabVideos.addEventListener("click", () => setTab("videos"));
tabNotes.addEventListener("click", () => setTab("notes"));

// ---------- Videos storage ----------
let videos = [];

function loadVideos() {
  try {
    videos = JSON.parse(localStorage.getItem(KEY_VIDEOS) || "[]");
  } catch {
    videos = [];
  }
  videoCount.textContent = String(videos.length);
}
function saveVideos() {
  localStorage.setItem(KEY_VIDEOS, JSON.stringify(videos));
  videoCount.textContent = String(videos.length);
}

// Convert selected video file to an object URL (session-based)
function createVideoObjectURL(file) {
  return URL.createObjectURL(file);
}

// Add video
addVideoBtn.addEventListener("click", () => {
  videoFormHint.textContent = "";
  const file = videoFile.files?.[0];
  const title = (videoTitle.value || "").trim();
  const owner = (videoOwner.value || "").trim();
  const q1 = (videoQ1.value || "").trim();
  const q2 = (videoQ2.value || "").trim();
  const desc = (videoDesc.value || "").trim();

  if (!file) return (videoFormHint.textContent = "Pick a video file.");
  if (!title) return (videoFormHint.textContent = "Add a title.");
  if (!owner) return (videoFormHint.textContent = "Select Aiden or Landon.");

  // NOTE: object URLs won't persist across reloads.
  // For persistent videos, you'd upload to storage (server) and store the hosted URL.
  const objectURL = createVideoObjectURL(file);

  const item = {
    id: crypto.randomUUID(),
    title,
    owner,
    q1,
    q2,
    desc,
    createdAt: new Date().toISOString(),
    objectURL,
    fileName: file.name,
    fileType: file.type,
    fileSize: file.size
  };

  videos.unshift(item);
  saveVideos();
  renderVideos();

  // reset
  videoFile.value = "";
  videoTitle.value = "";
  videoOwner.value = "";
  videoQ1.value = "";
  videoQ2.value = "";
  videoDesc.value = "";
  videoFormHint.textContent = "Added.";
  setTimeout(() => (videoFormHint.textContent = ""), 1500);
});

function renderVideos() {
  videoCards.innerHTML = "";
  if (!videos.length) {
    videoCards.innerHTML = `<div class="hint">No videos yet. Upload one on the left.</div>`;
    return;
  }

  for (const v of videos) {
    const el = document.createElement("div");
    el.className = "card";

    const date = new Date(v.createdAt);
    const dateStr = isNaN(date) ? "" : date.toLocaleString();

    el.innerHTML = `
      <h3>${escapeHtml(v.title)}</h3>
      <div class="meta">
        <span class="tag accent">${escapeHtml(v.owner)}</span>
        <span>${escapeHtml(v.fileName || "video")}</span>
        <span>${escapeHtml(dateStr)}</span>
      </div>

      <video muted playsinline preload="metadata"></video>

      <p class="desc">
        <b>Q1:</b> ${escapeHtml(v.q1 || "-")}<br/>
        <b>Q2:</b> ${escapeHtml(v.q2 || "-")}<br/>
        ${v.desc ? `<span style="opacity:.9"><b>Notes:</b> ${escapeHtml(v.desc)}</span>` : ""}
      </p>

      <div class="footer">
        <span class="pill">Hover to preview</span>
        <div class="mini">
          <button data-action="open">Open</button>
          <button data-action="del">Delete</button>
        </div>
      </div>
    `;

    const video = el.querySelector("video");
    // Best effort: objectURL is only valid for this session (unless you keep it alive).
    if (v.objectURL) video.src = v.objectURL;

    // Hover behavior: play/pause
    el.addEventListener("mouseenter", () => {
      try { video.currentTime = 0; video.play(); } catch {}
    });
    el.addEventListener("mouseleave", () => {
      try { video.pause(); } catch {}
    });

    el.querySelector('[data-action="open"]').addEventListener("click", () => {
      // Open in a simple modal window (new tab)
      if (!v.objectURL) return alert("This video link isn't available after reload in this prototype. For persistence, upload to cloud storage.");
      window.open(v.objectURL, "_blank");
    });

    el.querySelector('[data-action="del"]').addEventListener("click", () => {
      videos = videos.filter(x => x.id !== v.id);
      saveVideos();
      renderVideos();
    });

    videoCards.appendChild(el);
  }
}

// ---------- Notes (doc) ----------
let docSaveTimer = null;

function loadDoc() {
  let data;
  try {
    data = JSON.parse(localStorage.getItem(KEY_DOC) || "null");
  } catch {
    data = null;
  }

  docTitle.value = data?.title || "TSE Notes";
  editor.innerHTML = data?.html || `
    <h2>Welcome to TSE Notes</h2>
    <p>Write like Google Docs: format text, paste images, or use the image picker above.</p>
    <ul>
      <li><b>Bold / Italic / Underline</b> supported</li>
      <li>Images embed into the doc</li>
      <li>Autosaves to this browser</li>
    </ul>
  `;
}

function saveDoc(statusText = "Saved") {
  const payload = {
    title: docTitle.value || "TSE Notes",
    html: editor.innerHTML,
    updatedAt: new Date().toISOString()
  };
  localStorage.setItem(KEY_DOC, JSON.stringify(payload));
  saveStatus.textContent = `Autosave: ${statusText}`;
}

function scheduleDocSave() {
  saveStatus.textContent = "Autosave: typing‚Ä¶";
  if (docSaveTimer) clearTimeout(docSaveTimer);
  docSaveTimer = setTimeout(() => saveDoc("saved"), 500);
}

docTitle.addEventListener("input", scheduleDocSave);
editor.addEventListener("input", scheduleDocSave);

// Paste images into editor
editor.addEventListener("paste", async (e) => {
  const items = e.clipboardData?.items;
  if (!items) return;

  for (const item of items) {
    if (item.type.startsWith("image/")) {
      e.preventDefault();
      const file = item.getAsFile();
      if (file) {
        const dataUrl = await fileToDataUrl(file);
        insertImageAtCursor(dataUrl);
        scheduleDocSave();
      }
    }
  }
});

// Toolbar commands
document.querySelectorAll(".tool[data-cmd]").forEach(btn => {
  btn.addEventListener("click", () => {
    const cmd = btn.getAttribute("data-cmd");
    document.execCommand(cmd, false, null);
    editor.focus();
    scheduleDocSave();
  });
});

document.getElementById("h2Btn").addEventListener("click", () => {
  document.execCommand("formatBlock", false, "h2");
  editor.focus();
  scheduleDocSave();
});

document.getElementById("quoteBtn").addEventListener("click", () => {
  document.execCommand("formatBlock", false, "blockquote");
  editor.focus();
  scheduleDocSave();
});

document.getElementById("linkBtn").addEventListener("click", () => {
  const url = prompt("Enter URL:");
  if (!url) return;
  document.execCommand("createLink", false, url);
  editor.focus();
  scheduleDocSave();
});

document.getElementById("clearFormatBtn").addEventListener("click", () => {
  document.execCommand("removeFormat", false, null);
  editor.focus();
  scheduleDocSave();
});

// Insert image via picker
imageInsert.addEventListener("change", async () => {
  const file = imageInsert.files?.[0];
  if (!file) return;
  const dataUrl = await fileToDataUrl(file);
  insertImageAtCursor(dataUrl);
  imageInsert.value = "";
  scheduleDocSave();
});

// Download doc as HTML file
downloadHtmlBtn.addEventListener("click", () => {
  const title = (docTitle.value || "TSE Notes").trim();
  const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:40px auto;padding:0 16px;line-height:1.6}
  img{max-width:100%;height:auto;border-radius:12px}
  blockquote{border-left:4px solid #ddd;padding-left:12px;color:#444}
</style>
</head>
<body>
<h1>${escapeHtml(title)}</h1>
${editor.innerHTML}
</body>
</html>`.trim();

  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${sanitizeFileName(title)}.html`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// ---------- Clear + Export ----------
clearBtn.addEventListener("click", () => {
  const ok = confirm("Clear ALL local TSE data (videos list + notes + password on this browser)?");
  if (!ok) return;
  localStorage.removeItem(KEY_VIDEOS);
  localStorage.removeItem(KEY_DOC);
  localStorage.removeItem(KEY_PW);
  localStorage.removeItem(KEY_AUTH);
  videos = [];
  renderVideos();
  loadDoc();
  showAuth();
});

exportBtn.addEventListener("click", () => {
  const payload = {
    exportedAt: new Date().toISOString(),
    videos: videos.map(v => ({
      id: v.id,
      title: v.title,
      owner: v.owner,
      q1: v.q1,
      q2: v.q2,
      desc: v.desc,
      createdAt: v.createdAt,
      fileName: v.fileName,
      fileType: v.fileType,
      fileSize: v.fileSize,
      note: "Video bytes are not included in this export in the prototype."
    })),
    doc: {
      title: docTitle.value || "TSE Notes",
      html: editor.innerHTML
    }
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `tse-export-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// ---------- Helpers ----------
function escapeHtml(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function sanitizeFileName(name) {
  return String(name).replace(/[\\/:*?"<>|]+/g, "-").trim() || "document";
}
function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
function insertImageAtCursor(dataUrl) {
  editor.focus();

  const img = document.createElement("img");
  img.src = dataUrl;
  img.alt = "Inserted image";

  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) {
    editor.appendChild(img);
    return;
  }
  const range = sel.getRangeAt(0);
  range.collapse(false);
  range.insertNode(img);

  // Move cursor after image
  range.setStartAfter(img);
  range.setEndAfter(img);
  sel.removeAllRanges();
  sel.addRange(range);
}
</script>
</body>
</html>
