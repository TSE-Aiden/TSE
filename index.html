<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSE</title>
  <style>
    :root{
      --bg0:#070a12;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --good:#33d17a;
      --bad:#ff4d4d;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 70% 25%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(1000px 700px at 15% 20%, rgba(59,130,246,.14), transparent 60%),
        radial-gradient(900px 600px at 50% 85%, rgba(16,185,129,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .shell{
      max-width: 1320px;
      margin: 22px auto 36px;
      padding: 0 18px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .dot{
      width: 14px; height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.20);
    }
    .brand h1{
      font-size: 14px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      font-size: 12px;
      margin:0;
      color:var(--muted);
      line-height:1.1;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .badge{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .badge .dot{
      width: 10px; height: 10px;
      background: var(--bad);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 22px rgba(255,77,77,.35);
    }
    .badge.ok .dot{
      background: var(--good);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 22px rgba(51,209,122,.35);
    }
    .badge span{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    button, .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 13px;
      backdrop-filter: blur(10px);
    }
    button:hover, .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16); }
    button:active, .btn:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      align-items:start;
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .panel .hdr{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.07);
    }
    .panel .hdr h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .panel .hdr .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted2);
    }

    .panel .body{
      padding: 14px;
    }

    .row{
      display:grid;
      gap: 10px;
      margin-bottom: 12px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    input, select, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .inline2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .hint{
      font-size:12px;
      color: var(--muted2);
      line-height:1.35;
      margin-top: 10px;
    }

    .err{
      margin-top: 10px;
      font-size: 12px;
      color: var(--bad);
      white-space: pre-wrap;
    }

    /* Videos area */
    .videosTop{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .videosTop .search{
      flex: 1 1 360px;
      min-width: 240px;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      position:relative;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
    }

    .thumb{
      position:relative;
      aspect-ratio: 16/9;
      background: rgba(0,0,0,.35);
      overflow:hidden;
    }
    .thumb video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .thumb .fallback{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.35);
      font-size: 12px;
    }
    .thumb .play{
      position:absolute;
      inset:auto 10px 10px auto;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .meta{
      padding: 10px 10px 12px;
      display:grid;
      gap: 6px;
    }
    .title{
      font-size: 13px;
      font-weight: 650;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .subline{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }

    .empty{
      margin-top: 14px;
      padding: 16px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.12);
      color: rgba(255,255,255,.45);
      font-size: 13px;
    }

    /* Modal player */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width:min(1000px, 96vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHdr .t{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .modalHdr .t strong{
      font-size: 13px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modalHdr .t span{
      font-size: 12px;
      color: var(--muted);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modalBody{
      padding: 12px;
      background: rgba(0,0,0,.25);
    }
    .modalBody video{
      width:100%;
      max-height: 70vh;
      background: black;
      border-radius: 14px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>TSE</h1>
          <p>Videos + Notes · Shared via Cloudflare (R2 + D1)</p>
        </div>
      </div>

      <div class="actions">
        <div id="apiBadge" class="badge"><div class="dot"></div><span>API: checking…</span></div>
        <a class="btn" id="openApiBtn" target="_blank" rel="noreferrer">Open API</a>
        <button id="checkApiBtn">Check API</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <!-- Upload panel -->
      <div class="panel">
        <div class="hdr">
          <div>
            <h2>Upload video</h2>
            <p class="sub">Shared — appears for everyone using this site</p>
          </div>
          <div class="pill">Max 500MB</div>
        </div>

        <div class="body">
          <div class="row">
            <label>Video file</label>
            <input id="file" type="file" accept="video/*" />
          </div>

          <div class="row">
            <label>Title</label>
            <input id="title" placeholder="e.g., NQ Scalps — Jan 4" />
          </div>

          <div class="inline2">
            <div class="row">
              <label>Owner</label>
              <select id="owner">
                <option value="">(none)</option>
                <option value="Aiden">Aiden</option>
                <option value="Landon">Landon</option>
              </select>
            </div>
            <div class="row">
              <label>Sort tag</label>
              <input id="tag" placeholder="Trade Review / Setups / etc" />
            </div>
          </div>

          <div class="row">
            <label>Description Q1</label>
            <input id="q1" placeholder="What was the setup?" />
          </div>
          <div class="row">
            <label>Description Q2</label>
            <input id="q2" placeholder="What did you learn?" />
          </div>

          <div class="row">
            <label>Notes (optional)</label>
            <textarea id="notes" placeholder="Write notes attached to this video…"></textarea>
          </div>

          <div class="inline2">
            <button class="primary" id="uploadBtn">Upload</button>
            <button id="clearBtn">Clear</button>
          </div>

          <div class="hint">
            Tip: keep clips under 500MB for fastest uploads. If you see “Load failed” it usually means the request didn’t complete
            (wrong endpoint, missing binding, or server returned non-JSON).
          </div>
          <div id="uploadErr" class="err"></div>
        </div>
      </div>

      <!-- Videos panel -->
      <div class="panel">
        <div class="hdr">
          <div>
            <h2>Videos</h2>
            <p class="sub">YouTube-style cards · hover to preview</p>
          </div>
          <button id="loadBtn">Load</button>
        </div>

        <div class="body">
          <div class="videosTop">
            <input class="search" id="search" placeholder="Search videos by title, owner, tag…" />
            <div class="pill" id="countPill">0 items</div>
          </div>

          <div id="cards" class="cards"></div>
          <div id="empty" class="empty" style="display:none;">No videos. Upload one, then click <b>Load</b>.</div>

          <div id="listErr" class="err"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHdr">
        <div class="t">
          <strong id="mTitle">Video</strong>
          <span id="mSub">—</span>
        </div>
        <div style="display:flex; gap:10px;">
          <a class="btn" id="mOpen" target="_blank" rel="noreferrer">Open stream</a>
          <button id="mClose">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <video id="mVideo" controls playsinline></video>
      </div>
    </div>
  </div>

  <script>
    // IMPORTANT: point UI at the API Worker domain
    const API_BASE = "https://api.tseapp.com";

    const el = (id) => document.getElementById(id);

    const apiBadge = el("apiBadge");
    const openApiBtn = el("openApiBtn");
    const checkApiBtn = el("checkApiBtn");
    const refreshBtn = el("refreshBtn");

    const fileEl = el("file");
    const titleEl = el("title");
    const ownerEl = el("owner");
    const tagEl = el("tag");
    const q1El = el("q1");
    const q2El = el("q2");
    const notesEl = el("notes");
    const uploadBtn = el("uploadBtn");
    const clearBtn = el("clearBtn");
    const uploadErr = el("uploadErr");

    const loadBtn = el("loadBtn");
    const searchEl = el("search");
    const cardsEl = el("cards");
    const emptyEl = el("empty");
    const countPill = el("countPill");
    const listErr = el("listErr");

    const modal = el("modal");
    const mClose = el("mClose");
    const mTitle = el("mTitle");
    const mSub = el("mSub");
    const mVideo = el("mVideo");
    const mOpen = el("mOpen");

    openApiBtn.href = `${API_BASE}/api/health`;

    function setBadge(ok, text) {
      apiBadge.classList.toggle("ok", !!ok);
      apiBadge.querySelector("span").textContent = text;
    }

    async function checkAPI() {
      try {
        const r = await fetch(`${API_BASE}/api/health`, { method: "GET" });
        const j = await r.json().catch(() => null);
        if (!r.ok) throw new Error(j?.details || j?.error || `HTTP ${r.status}`);
        const good = !!j?.ok;
        const bindings = j?.bindings ? ` (D1:${j.bindings.d1 ? "✓" : "×"} R2:${j.bindings.r2 ? "✓" : "×"})` : "";
        setBadge(good, good ? `API: online${bindings}` : "API: offline");
        return good;
      } catch (e) {
        setBadge(false, "API: offline");
        return false;
      }
    }

    function clearUploadForm() {
      fileEl.value = "";
      titleEl.value = "";
      ownerEl.value = "";
      tagEl.value = "";
      q1El.value = "";
      q2El.value = "";
      notesEl.value = "";
      uploadErr.textContent = "";
    }

    clearBtn.addEventListener("click", clearUploadForm);
    refreshBtn.addEventListener("click", async () => {
      await checkAPI();
      await loadVideos();
    });
    checkApiBtn.addEventListener("click", checkAPI);

    function streamUrlFor(id) {
      return `${API_BASE}/api/videos/${encodeURIComponent(id)}/stream`;
    }

    function fmtTime(ts) {
      if (!ts) return "";
      try {
        return new Date(ts).toLocaleString();
      } catch { return ""; }
    }

    // Hover preview (muted autoplay) — safe & lightweight
    function wireHoverPreview(videoEl) {
      let started = false;

      const start = async () => {
        if (started) return;
        started = true;
        videoEl.muted = true;
        videoEl.playsInline = true;
        videoEl.loop = true;
        try { await videoEl.play(); } catch {}
      };

      const stop = () => {
        started = false;
        try { videoEl.pause(); videoEl.currentTime = 0; } catch {}
      };

      videoEl.addEventListener("mouseenter", start);
      videoEl.addEventListener("mouseleave", stop);

      // Also stop if tab loses focus
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) stop();
      });
    }

    function openModal(v) {
      const url = streamUrlFor(v.id);
      mTitle.textContent = v.title || "(untitled)";
      mSub.textContent = `${v.owner || "(no owner)"} · ${v.tag || "(no tag)"} · ${fmtTime(v.createdAt) || ""}`.trim();
      mVideo.src = url;
      mOpen.href = url;
      modal.classList.add("open");
      setTimeout(() => { try { mVideo.play(); } catch {} }, 0);
    }

    function closeModal() {
      modal.classList.remove("open");
      try { mVideo.pause(); } catch {}
      mVideo.src = "";
    }

    mClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    function render(videos) {
      cardsEl.innerHTML = "";
      listErr.textContent = "";

      countPill.textContent = `${videos.length} item${videos.length === 1 ? "" : "s"}`;
      emptyEl.style.display = videos.length ? "none" : "block";

      for (const v of videos) {
        const card = document.createElement("div");
        card.className = "card";

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        const vid = document.createElement("video");
        vid.src = streamUrlFor(v.id);
        vid.preload = "metadata";
        vid.muted = true;
        vid.playsInline = true;

        const fallback = document.createElement("div");
        fallback.className = "fallback";
        fallback.textContent = "Preview";

        // If stream fails, keep fallback visible
        vid.addEventListener("loadeddata", () => { fallback.style.display = "none"; });
        vid.addEventListener("error", () => { fallback.style.display = "flex"; });

        const play = document.createElement("div");
        play.className = "play";
        play.innerHTML = "▶︎";

        thumb.appendChild(vid);
        thumb.appendChild(fallback);
        thumb.appendChild(play);

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = v.title || "(untitled)";

        const sub = document.createElement("div");
        sub.className = "subline";

        const left = document.createElement("span");
        left.textContent = v.owner || "(no owner)";

        const right = document.createElement("span");
        right.textContent = v.tag || "";

        sub.appendChild(left);
        sub.appendChild(right);

        meta.appendChild(t);
        meta.appendChild(sub);

        card.appendChild(thumb);
        card.appendChild(meta);

        // hover preview + click modal
        wireHoverPreview(vid);
        card.addEventListener("click", () => openModal(v));

        cardsEl.appendChild(card);
      }
    }

    function filterVideos(videos, q) {
      q = (q || "").trim().toLowerCase();
      if (!q) return videos;
      return videos.filter(v => {
        const hay = `${v.title||""} ${v.owner||""} ${v.tag||""} ${v.q1||""} ${v.q2||""} ${v.notes||""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    let lastVideos = [];

    async function loadVideos() {
      try {
        const r = await fetch(`${API_BASE}/api/videos`, { method: "GET" });
        const j = await r.json().catch(() => null);
        if (!r.ok) throw new Error(j?.details || j?.error || `HTTP ${r.status}`);
        lastVideos = Array.isArray(j?.videos) ? j.videos : [];
        render(filterVideos(lastVideos, searchEl.value));
      } catch (e) {
        listErr.textContent = `Load failed: ${e.message || e}`;
        render([]);
      }
    }

    loadBtn.addEventListener("click", loadVideos);

    searchEl.addEventListener("input", () => {
      render(filterVideos(lastVideos, searchEl.value));
    });

    uploadBtn.addEventListener("click", async () => {
      uploadErr.textContent = "";
      const file = fileEl.files?.[0];
      if (!file) {
        uploadErr.textContent = "Choose a video file first.";
        return;
      }

      try {
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Uploading…";

        const fd = new FormData();

        // MUST be "file" — matches the Worker
        fd.append("file", file, file.name);

        fd.append("title", titleEl.value || "");
        fd.append("owner", ownerEl.value || "");
        fd.append("tag", tagEl.value || "");
        fd.append("q1", q1El.value || "");
        fd.append("q2", q2El.value || "");
        fd.append("notes", notesEl.value || "");

        const r = await fetch(`${API_BASE}/api/videos/upload`, {
          method: "POST",
          body: fd
        });

        const j = await r.json().catch(() => null);
        if (!r.ok) throw new Error(j?.details || j?.error || `HTTP ${r.status}`);

        // Auto refresh list after upload
        await loadVideos();

        // Optional: open the uploaded video immediately
        if (j?.id) {
          const v = lastVideos.find(x => x.id === j.id) || { id: j.id, title: titleEl.value, owner: ownerEl.value, tag: tagEl.value, createdAt: j.createdAt };
          openModal(v);
        }

        clearUploadForm();
      } catch (e) {
        uploadErr.textContent = `Upload failed: ${e.message || e}`;
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload";
      }
    });

    // boot
    (async () => {
      await checkAPI();
      // lazy load on open (you can auto-load if you want):
      // await loadVideos();
    })();
  </script>
</body>
</html>
