<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSE</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1626;
      --panel2:#0c1220;
      --muted:#8fa1c7;
      --text:#e7eefc;
      --line:rgba(255,255,255,.09);
      --accent:#6aa6ff;
      --good:#46e39a;
      --bad:#ff5d7a;
      --warn:#ffd166;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(106,166,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(70,227,154,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(106,166,255,.8), rgba(70,227,154,.35) 45%, rgba(255,255,255,.06) 70%);
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(106,166,255,.12);
    }
    .brand h1{font-size:16px;margin:0;letter-spacing:.5px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.04);
      color:var(--text);padding:10px 12px;border-radius:999px;font-weight:600;font-size:13px;
      transition: transform .08s ease, background .2s ease;
    }
    .tab:hover{transform: translateY(-1px);background:rgba(255,255,255,.07)}
    .tab.active{background:rgba(106,166,255,.16);border-color:rgba(106,166,255,.3)}
    .right{
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      font-size:12px;color:var(--muted);border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;background:rgba(0,0,0,.18);
      display:flex; align-items:center; gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:12px; color:var(--text); font-weight:700; font-size:13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09)}
    .btn.primary{background: rgba(106,166,255,.16); border-color: rgba(106,166,255,.35)}
    .btn.danger{background: rgba(255,93,122,.12); border-color: rgba(255,93,122,.28)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .grid{display:grid; grid-template-columns: 420px 1fr; gap:16px; margin-top:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{position:relative; top:auto}}
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .hd span{color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted)}
    input[type="text"], textarea, select{
      width:100%;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .hint{font-size:12px;color:var(--muted);line-height:1.3}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .toolbar .spacer{flex:1}
    .search{
      display:flex; gap:10px; align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .search input{
      flex:1; background: rgba(0,0,0,.22);
      border:1px solid var(--line); border-radius:12px;
      padding:10px 10px; color:var(--text);
    }
    .selectSmall{width:170px}
    .list{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .list{grid-template-columns: 1fr} }
    .vcard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      overflow:hidden;
      position:relative;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
    }
    .vcard:hover{
      transform: translateY(-2px);
      border-color: rgba(106,166,255,.35);
      background: rgba(0,0,0,.26);
    }
    .thumb{
      height:150px;
      background: radial-gradient(circle at 30% 20%, rgba(106,166,255,.25), transparent 55%),
                  radial-gradient(circle at 70% 40%, rgba(70,227,154,.18), transparent 55%),
                  rgba(255,255,255,.04);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb .play{
      width:52px;height:52px;border-radius:50%;
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.25);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      font-size:18px;
    }
    .vmeta{padding:12px}
    .vtitle{
      margin:0 0 8px;
      font-size:14px;
      line-height:1.25;
      font-weight:800;
      letter-spacing:.2px;
    }
    .chips{display:flex; gap:6px; flex-wrap:wrap; align-items:center}
    .chip{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .chip.owner{
      color: rgba(255,255,255,.9);
      border-color: rgba(106,166,255,.25);
      background: rgba(106,166,255,.14);
    }
    .vactions{
      padding:12px;
      display:flex; gap:8px; align-items:center;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .preview{
      position:absolute; inset:0;
      opacity:0; pointer-events:none;
      transition: opacity .15s ease;
      background: rgba(0,0,0,.75);
      display:flex; align-items:center; justify-content:center;
      padding:10px;
    }
    .vcard:hover .preview{opacity:1; pointer-events:auto}
    .preview video{
      width:100%;
      max-height:220px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:#000;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.62);
      display:none; align-items:center; justify-content:center; padding:20px; z-index:50;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(960px, 100%);
      border:1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid var(--line); background: rgba(0,0,0,.14);
    }
    .modal .mhd .title{font-weight:900}
    .modal .mbd{padding:12px}
    .modal video{width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:#000}
    .toast{
      position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px; border-radius:12px;
      color: var(--text);
      display:none;
      z-index:60;
      box-shadow: var(--shadow);
      max-width: min(820px, 92vw);
    }
    .toast.show{display:block}

    /* Notes */
    .notesWrap{display:grid; grid-template-columns: 280px 1fr; gap:16px; margin-top:16px}
    @media (max-width: 980px){ .notesWrap{grid-template-columns:1fr} }
    .noteList{padding:12px; display:flex; flex-direction:column; gap:10px}
    .noteItem{
      cursor:pointer;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      padding:10px;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
    }
    .noteItem:hover{transform: translateY(-1px); border-color: rgba(106,166,255,.32); background: rgba(0,0,0,.24)}
    .noteItem.active{border-color: rgba(106,166,255,.45); background: rgba(106,166,255,.12)}
    .noteItem .t{font-weight:900; font-size:13px; margin:0 0 4px}
    .noteItem .s{color:var(--muted); font-size:12px; margin:0}
    .docTop{
      display:flex; gap:10px; align-items:center; padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .docTitle{flex:1; font-weight:900}
    .docToolbar{display:flex; gap:8px; flex-wrap:wrap}
    .doc{
      min-height: 520px;
      padding:16px;
      outline:none;
      line-height:1.45;
    }
    .dropHint{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 12px;
      color: var(--muted);
      font-size:12px;
      background: rgba(0,0,0,.14);
    }

    /* Resizable images in editor */
    .imgWrap{
      display:inline-block;
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      overflow:hidden;
      background:#000;
      margin:6px 0;
      max-width: 100%;
    }
    .imgWrap img{display:block; width:100%; height:auto}
    .handle{
      position:absolute; width:12px; height:12px; border-radius:3px;
      background: rgba(106,166,255,.9);
      border:1px solid rgba(0,0,0,.35);
      right:8px; bottom:8px; cursor:nwse-resize;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .progressRow{display:flex; gap:10px; align-items:center}
    progress{width:100%; height:12px; border-radius:999px; overflow:hidden}
    progress::-webkit-progress-bar{background: rgba(255,255,255,.08)}
    progress::-webkit-progress-value{background: rgba(106,166,255,.75)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>TSE</h1>
          <p>Videos + Notes • Shared via Cloudflare (R2 + D1)</p>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabVideos">Videos</button>
        <button class="tab" id="tabNotes">Notes</button>
      </div>

      <div class="right">
        <div class="pill" title="API connection status">
          <span class="dot bad" id="apiDot"></span>
          <span id="apiText">API: not checked</span>
        </div>
        <button class="btn" id="btnCheckApi">Check API</button>
        <button class="btn primary" id="btnRefresh">Refresh</button>
      </div>
    </div>

    <!-- VIDEOS VIEW -->
    <div id="viewVideos">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Upload video</h2>
              <span>Shared — appears for everyone with Access</span>
            </div>
            <span class="small" id="uploadMax">Max 500MB</span>
          </div>
          <div class="bd">
            <div class="field">
              <label>Video file</label>
              <input type="file" id="file" accept="video/*" />
              <div class="hint">Tip: keep clips under 500MB for fastest uploads.</div>
            </div>

            <div class="field">
              <label>Title</label>
              <input type="text" id="title" placeholder="e.g., NQ Scalps – Jan 4" />
            </div>

            <div class="row">
              <div class="field">
                <label>Owner (Aiden or Landon)</label>
                <select id="owner">
                  <option value="Aiden">Aiden</option>
                  <option value="Landon">Landon</option>
                </select>
              </div>
              <div class="field">
                <label>Sort tag</label>
                <select id="tag">
                  <option value="Trade Review">Trade Review</option>
                  <option value="Strategy">Strategy</option>
                  <option value="Journal">Journal</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <div class="field">
              <label>Description Q1</label>
              <input type="text" id="q1" placeholder="What was the setup?" />
            </div>
            <div class="field">
              <label>Description Q2</label>
              <input type="text" id="q2" placeholder="What did you learn?" />
            </div>
            <div class="field">
              <label>Notes (optional)</label>
              <textarea id="vnotes" placeholder="Write notes attached to this video..."></textarea>
            </div>

            <div class="progressRow" style="margin-top:10px;">
              <button class="btn primary" id="btnUpload">Upload</button>
              <button class="btn" id="btnClearForm">Clear</button>
            </div>

            <div style="margin-top:10px;">
              <progress id="prog" value="0" max="100"></progress>
              <div class="small" id="progText" style="margin-top:6px;">Idle</div>
            </div>

            <div class="sep"></div>

            <div class="hint">
              If upload/list calls fail with 401/403, open <b>api.tseapp.com</b> once so Access can set your session, then refresh.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="search">
            <input id="search" placeholder="Search videos by title, owner, notes..." />
            <select id="sort" class="selectSmall">
              <option value="new">Newest</option>
              <option value="old">Oldest</option>
              <option value="aiden">Owner: Aiden</option>
              <option value="landon">Owner: Landon</option>
            </select>
            <button class="btn" id="btnLoad">Load</button>
          </div>
          <div class="list" id="videoList"></div>
        </div>
      </div>
    </div>

    <!-- NOTES VIEW -->
    <div id="viewNotes" style="display:none;">
      <div class="notesWrap">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Notes</h2>
              <span>Google-doc style • drag & drop images • resizable</span>
            </div>
          </div>
          <div class="noteList">
            <button class="btn primary" id="btnNewNote">New note</button>
            <button class="btn danger" id="btnDeleteNote">Delete note</button>
            <div class="dropHint">
              Drop images into the doc area → they’ll insert where your cursor is.
              Drag the blue corner to resize.
            </div>
            <div class="sep"></div>
            <div id="noteItems"></div>
          </div>
        </div>

        <div class="card">
          <div class="docTop">
            <div class="docTitle" id="docTitle">Untitled</div>
            <div class="docToolbar">
              <button class="btn" id="btnBold"><b>B</b></button>
              <button class="btn" id="btnItalic"><i>I</i></button>
              <button class="btn" id="btnUnderline"><u>U</u></button>
              <button class="btn" id="btnH2">H2</button>
              <button class="btn" id="btnBullets">• List</button>
              <button class="btn" id="btnInsertImage">Insert image</button>
              <button class="btn" id="btnSaveNote">Save</button>
            </div>
          </div>
          <div class="bd">
            <input type="text" id="noteTitleInput" placeholder="Note title..." style="margin-bottom:12px;" />
            <div class="doc card" id="doc" contenteditable="true"></div>
            <div class="small" id="noteStatus" style="margin-top:10px;">Autosave on typing.</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Video modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="mhd">
        <div class="title" id="modalTitle">Video</div>
        <button class="btn" id="btnCloseModal">Close</button>
      </div>
      <div class="mbd">
        <video id="modalVideo" controls playsinline></video>
        <div class="sep"></div>
        <div class="small" id="modalMeta"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    // If your API is on api.tseapp.com:
    const API_BASE = "https://api.tseapp.com";

    // =========================
    // UTIL
    // =========================
    const $ = (id) => document.getElementById(id);
    const toast = (msg, ms=2600) => {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__t_toast);
      window.__t_toast = setTimeout(() => t.classList.remove("show"), ms);
    };
    const fmtDate = (iso) => {
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined, {year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      }catch{return iso || ""}
    };

    // =========================
    // API HELPERS
    // =========================
    async function apiFetch(path, options = {}) {
      const url = path.startsWith("http") ? path : (API_BASE + path);
      const res = await fetch(url, {
        credentials: "include",
        ...options,
      });
      // If Access blocks, you might get 403/401 or an HTML login response.
      const ctype = res.headers.get("content-type") || "";
      if (!res.ok) {
        let body = "";
        try { body = ctype.includes("application/json") ? JSON.stringify(await res.json()) : await res.text(); } catch {}
        throw new Error(`API ${res.status}: ${body.slice(0, 160)}`);
      }
      if (ctype.includes("application/json")) return await res.json();
      return await res.text();
    }

    async function checkApi() {
      try{
        const data = await apiFetch("/api/videos");
        $("apiDot").className = "dot ok";
        $("apiText").textContent = "API: connected";
        return data;
      }catch(e){
        $("apiDot").className = "dot bad";
        $("apiText").textContent = "API: blocked/offline";
        toast("API not reachable. If using Access: open api.tseapp.com once, login, then retry.");
        return null;
      }
    }

    // =========================
    // VIDEOS
    // =========================
    let allVideos = [];

    function videoCard(v){
      const streamUrl = v.streamUrl || `${API_BASE}/v/${v.id}`;
      const owner = v.owner || "—";
      const created = fmtDate(v.created_at);
      const title = v.title || "Untitled";
      const q1 = v.q1 || "";
      const q2 = v.q2 || "";
      const notes = v.notes || "";

      const el = document.createElement("div");
      el.className = "vcard";
      el.innerHTML = `
        <div class="thumb">
          <div class="play">▶</div>
          <div class="preview">
            <video muted playsinline preload="metadata"></video>
          </div>
        </div>
        <div class="vmeta">
          <p class="vtitle"></p>
          <div class="chips">
            <span class="chip owner"></span>
            <span class="chip">${created}</span>
          </div>
          ${(q1 || q2) ? `<div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35">
            ${q1 ? `<div><b style="color:var(--text)">Q1:</b> ${escapeHtml(q1)}</div>` : ""}
            ${q2 ? `<div><b style="color:var(--text)">Q2:</b> ${escapeHtml(q2)}</div>` : ""}
          </div>` : ""}
          ${notes ? `<div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35">
            <b style="color:var(--text)">Notes:</b> ${escapeHtml(notes).slice(0, 140)}${escapeHtml(notes).length>140?"…":""}
          </div>` : ""}
        </div>
        <div class="vactions">
          <button class="btn primary btnPlay">Play</button>
          <button class="btn btnCopy">Copy link</button>
          <span class="spacer"></span>
          <button class="btn danger btnDelete">Delete</button>
        </div>
      `;

      el.querySelector(".vtitle").textContent = title;
      el.querySelector(".chip.owner").textContent = owner;

      const preview = el.querySelector(".preview video");
      preview.src = streamUrl;

      // Hover preview: play silently
      el.addEventListener("mouseenter", () => {
        preview.currentTime = 0;
        preview.play().catch(()=>{});
      });
      el.addEventListener("mouseleave", () => {
        preview.pause();
      });

      el.querySelector(".btnPlay").onclick = () => openModal(v, streamUrl);
      el.querySelector(".btnCopy").onclick = async () => {
        try{
          await navigator.clipboard.writeText(streamUrl);
          toast("Link copied");
        }catch{
          toast("Couldn’t copy. Here it is: " + streamUrl, 4200);
        }
      };
      el.querySelector(".btnDelete").onclick = () => deleteVideo(v.id, title);
      return el;
    }

    function renderVideos(){
      const q = $("search").value.trim().toLowerCase();
      const mode = $("sort").value;

      let vids = [...allVideos];

      if (mode === "old") vids.reverse();
      if (mode === "aiden") vids = vids.filter(v => (v.owner||"").toLowerCase() === "aiden");
      if (mode === "landon") vids = vids.filter(v => (v.owner||"").toLowerCase() === "landon");

      if (q){
        vids = vids.filter(v => {
          const hay = [
            v.title, v.owner, v.q1, v.q2, v.notes
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      const list = $("videoList");
      list.innerHTML = "";
      if (!vids.length){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.style.gridColumn = "1 / -1";
        empty.textContent = "No videos yet. Upload one on the left.";
        list.appendChild(empty);
        return;
      }
      vids.forEach(v => list.appendChild(videoCard(v)));
    }

    async function loadVideos(){
      $("btnLoad").disabled = true;
      try{
        const data = await apiFetch("/api/videos");
        allVideos = (data && data.videos) ? data.videos : [];
        // Ensure streamUrl exists
        allVideos = allVideos.map(v => ({
          ...v,
          streamUrl: v.streamUrl || `${API_BASE}/v/${v.id}`,
        }));
        $("apiDot").className = "dot ok";
        $("apiText").textContent = "API: connected";
        renderVideos();
        toast("Loaded videos");
      }catch(e){
        $("apiDot").className = "dot bad";
        $("apiText").textContent = "API: blocked/offline";
        toast("Load failed. If Access: open api.tseapp.com, login, then retry.", 4200);
        console.error(e);
      }finally{
        $("btnLoad").disabled = false;
      }
    }

    async function deleteVideo(id, title){
      if (!confirm(`Delete "${title}"?\nThis removes it for everyone.`)) return;
      try{
        await apiFetch(`/api/videos/${encodeURIComponent(id)}`, { method:"DELETE" });
        allVideos = allVideos.filter(v => v.id !== id);
        renderVideos();
        toast("Deleted");
      }catch(e){
        toast("Delete failed. Check Access / permissions.");
        console.error(e);
      }
    }

    function openModal(v, url){
      $("modalTitle").textContent = v.title || "Video";
      $("modalMeta").innerHTML = `
        <div><b>Owner:</b> ${escapeHtml(v.owner || "")}</div>
        <div><b>Created:</b> ${escapeHtml(fmtDate(v.created_at || ""))}</div>
        ${v.q1 ? `<div style="margin-top:6px"><b>Q1:</b> ${escapeHtml(v.q1)}</div>` : ""}
        ${v.q2 ? `<div style="margin-top:6px"><b>Q2:</b> ${escapeHtml(v.q2)}</div>` : ""}
        ${v.notes ? `<div style="margin-top:6px"><b>Notes:</b> ${escapeHtml(v.notes)}</div>` : ""}
      `;
      const mv = $("modalVideo");
      mv.src = url;
      $("modalBack").classList.add("show");
      mv.play().catch(()=>{});
    }

    $("btnCloseModal").onclick = () => {
      const mv = $("modalVideo");
      mv.pause();
      mv.src = "";
      $("modalBack").classList.remove("show");
    };
    $("modalBack").addEventListener("click", (e) => {
      if (e.target === $("modalBack")) $("btnCloseModal").click();
    });

    // Upload with progress
    async function uploadVideo(){
      const file = $("file").files[0];
      const title = $("title").value.trim();
      const owner = $("owner").value;
      const tag = $("tag").value; // stored into q1 prefix (optional)
      const q1 = $("q1").value.trim();
      const q2 = $("q2").value.trim();
      const notes = $("vnotes").value.trim();

      if (!file) return toast("Pick a video file first.");
      if (!title) return toast("Add a title.");
      const MAX = 500 * 1024 * 1024;
      if (file.size > MAX) return toast("That file is over 500MB.");

      $("btnUpload").disabled = true;
      $("prog").value = 0;
      $("progText").textContent = "Preparing upload…";

      try{
        // Use XHR so we can show upload progress
        const form = new FormData();
        form.append("file", file);
        form.append("title", title);
        form.append("owner", owner);
        // store tag inside q1 if you want, without changing backend schema
        form.append("q1", tag ? `[${tag}] ${q1}` : q1);
        form.append("q2", q2);
        form.append("notes", notes);

        await xhrUpload(`${API_BASE}/api/upload`, form, (pct) => {
          $("prog").value = pct;
          $("progText").textContent = `Uploading… ${pct}%`;
        });

        $("prog").value = 100;
        $("progText").textContent = "Upload complete — refreshing list…";
        await loadVideos();
        toast("Uploaded!");
        clearForm();
      }catch(e){
        console.error(e);
        $("progText").textContent = "Upload failed.";
        toast("Upload failed. If Access: open api.tseapp.com and login, then try again.", 4500);
      }finally{
        $("btnUpload").disabled = false;
        setTimeout(()=>{ $("prog").value = 0; $("progText").textContent="Idle"; }, 1200);
      }
    }

    function xhrUpload(url, formData, onProgress){
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.withCredentials = true;

        xhr.upload.onprogress = (evt) => {
          if (!evt.lengthComputable) return;
          const pct = Math.round((evt.loaded / evt.total) * 100);
          onProgress(Math.min(99, Math.max(1, pct))); // keep 100 for completion
        };

        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve(xhr.responseText);
          } else {
            reject(new Error(`Upload failed: ${xhr.status} ${xhr.responseText?.slice?.(0,200)}`));
          }
        };
        xhr.onerror = () => reject(new Error("Network error"));
        xhr.send(formData);
      });
    }

    function clearForm(){
      $("file").value = "";
      $("title").value = "";
      $("q1").value = "";
      $("q2").value = "";
      $("vnotes").value = "";
      $("owner").value = "Aiden";
      $("tag").value = "Trade Review";
    }

    $("btnUpload").onclick = uploadVideo;
    $("btnClearForm").onclick = clearForm;
    $("btnLoad").onclick = loadVideos;
    $("btnRefresh").onclick = loadVideos;
    $("search").addEventListener("input", renderVideos);
    $("sort").addEventListener("change", renderVideos);
    $("btnCheckApi").onclick = async () => { await checkApi(); };

    // =========================
    // NOTES (LOCAL — persists across tab closes)
    // =========================
    // Notes are stored in localStorage per device for now.
    // If you want shared notes too, we can add a D1 table + /api/notes endpoints.
    const NOTES_KEY = "tse_notes_v1";
    let notes = [];
    let activeNoteId = null;

    function loadNotesLocal(){
      try{
        notes = JSON.parse(localStorage.getItem(NOTES_KEY) || "[]");
      }catch{ notes = []; }
      if (!Array.isArray(notes)) notes = [];
      if (!notes.length) {
        const id = crypto.randomUUID();
        notes.push({ id, title: "Welcome", html: "<p>Drop images here. Resize with the blue corner.</p>", updatedAt: Date.now() });
        activeNoteId = id;
        saveNotesLocal();
      } else if (!activeNoteId) {
        activeNoteId = notes[0].id;
      }
    }

    function saveNotesLocal(){
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    }

    function renderNoteList(){
      const wrap = $("noteItems");
      wrap.innerHTML = "";
      notes
        .slice()
        .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0))
        .forEach(n => {
          const item = document.createElement("div");
          item.className = "noteItem" + (n.id === activeNoteId ? " active" : "");
          item.innerHTML = `
            <p class="t"></p>
            <p class="s"></p>
          `;
          item.querySelector(".t").textContent = n.title || "Untitled";
          item.querySelector(".s").textContent = new Date(n.updatedAt||Date.now()).toLocaleString();
          item.onclick = () => { setActiveNote(n.id); };
          wrap.appendChild(item);
        });
    }

    function setActiveNote(id){
      activeNoteId = id;
      const n = notes.find(x => x.id === id);
      if (!n) return;
      $("docTitle").textContent = n.title || "Untitled";
      $("noteTitleInput").value = n.title || "";
      $("doc").innerHTML = n.html || "<p></p>";
      renderNoteList();
      $("noteStatus").textContent = "Loaded.";
    }

    function upsertActiveNote(){
      const title = $("noteTitleInput").value.trim() || "Untitled";
      const html = $("doc").innerHTML;
      let n = notes.find(x => x.id === activeNoteId);
      if (!n){
        activeNoteId = crypto.randomUUID();
        n = { id: activeNoteId, title, html, updatedAt: Date.now() };
        notes.push(n);
      } else {
        n.title = title;
        n.html = html;
        n.updatedAt = Date.now();
      }
      $("docTitle").textContent = title;
      saveNotesLocal();
      renderNoteList();
      $("noteStatus").textContent = "Saved.";
    }

    function newNote(){
      activeNoteId = crypto.randomUUID();
      notes.push({ id: activeNoteId, title: "New note", html: "<p></p>", updatedAt: Date.now() });
      saveNotesLocal();
      setActiveNote(activeNoteId);
      toast("New note created");
    }

    function deleteNote(){
      if (!activeNoteId) return;
      const n = notes.find(x => x.id === activeNoteId);
      if (!confirm(`Delete note "${n?.title || "Untitled"}"?`)) return;
      notes = notes.filter(x => x.id !== activeNoteId);
      if (!notes.length) {
        activeNoteId = null;
        newNote();
        return;
      }
      activeNoteId = notes[0].id;
      saveNotesLocal();
      setActiveNote(activeNoteId);
      toast("Note deleted");
    }

    // Editor formatting
    function cmd(command, value=null){
      document.execCommand(command, false, value);
      $("doc").focus();
      autosaveSoon();
    }
    $("btnBold").onclick = ()=>cmd("bold");
    $("btnItalic").onclick = ()=>cmd("italic");
    $("btnUnderline").onclick = ()=>cmd("underline");
    $("btnH2").onclick = ()=>cmd("formatBlock","h2");
    $("btnBullets").onclick = ()=>cmd("insertUnorderedList");
    $("btnSaveNote").onclick = ()=>upsertActiveNote();
    $("btnNewNote").onclick = newNote;
    $("btnDeleteNote").onclick = deleteNote;

    // Insert image from file picker
    $("btnInsertImage").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "image/*";
      inp.onchange = async () => {
        const f = inp.files?.[0];
        if (!f) return;
        const dataUrl = await readAsDataURL(f);
        insertResizableImage(dataUrl);
        autosaveSoon();
      };
      inp.click();
    };

    // Drag/drop images into doc
    const doc = $("doc");
    doc.addEventListener("dragover", (e) => {
      e.preventDefault();
    });
    doc.addEventListener("drop", async (e) => {
      e.preventDefault();
      const files = [...(e.dataTransfer?.files || [])].filter(f => f.type.startsWith("image/"));
      if (!files.length) return;

      // Insert at caret if possible
      placeCaretFromPoint(e);

      for (const f of files){
        const dataUrl = await readAsDataURL(f);
        insertResizableImage(dataUrl);
      }
      autosaveSoon();
      toast(`Inserted ${files.length} image(s)`);
    });

    // Autosave on typing
    let autosaveTimer = null;
    function autosaveSoon(){
      $("noteStatus").textContent = "Editing…";
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        upsertActiveNote();
        $("noteStatus").textContent = "Autosaved.";
      }, 450);
    }
    doc.addEventListener("input", autosaveSoon);
    $("noteTitleInput").addEventListener("input", autosaveSoon);

    // Make inserted images resizable
    function insertResizableImage(dataUrl){
      // Build wrapper
      const wrap = document.createElement("span");
      wrap.className = "imgWrap";
      wrap.contentEditable = "false";
      wrap.style.width = "320px"; // default size
      wrap.innerHTML = `<img src="${dataUrl}" alt="image"><span class="handle" title="Drag to resize"></span>`;

      insertNodeAtCaret(wrap);

      // Add a trailing space so you can continue typing
      insertNodeAtCaret(document.createTextNode(" "));

      // Hook resize
      const handle = wrap.querySelector(".handle");
      let startX = 0, startW = 0;

      const onMove = (ev) => {
        const dx = (ev.clientX || (ev.touches && ev.touches[0]?.clientX) || 0) - startX;
        const newW = Math.max(120, Math.min(doc.clientWidth - 24, startW + dx));
        wrap.style.width = newW + "px";
      };

      const onUp = () => {
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        window.removeEventListener("touchmove", onMove);
        window.removeEventListener("touchend", onUp);
        autosaveSoon();
      };

      const onDown = (ev) => {
        ev.preventDefault();
        startX = (ev.clientX || (ev.touches && ev.touches[0]?.clientX) || 0);
        startW = wrap.getBoundingClientRect().width;
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("touchend", onUp);
      };

      handle.addEventListener("mousedown", onDown);
      handle.addEventListener("touchstart", onDown, {passive:false});
    }

    function readAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function insertNodeAtCaret(node){
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0){
        doc.appendChild(node);
        return;
      }
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(node);
      // Move caret after node
      range.setStartAfter(node);
      range.setEndAfter(node);
      sel.removeAllRanges();
      sel.addRange(range);
    }

    function placeCaretFromPoint(e){
      const x = e.clientX, y = e.clientY;
      const range = document.caretRangeFromPoint ? document.caretRangeFromPoint(x, y)
                    : (document.caretPositionFromPoint ? (() => {
                      const pos = document.caretPositionFromPoint(x, y);
                      if (!pos) return null;
                      const r = document.createRange();
                      r.setStart(pos.offsetNode, pos.offset);
                      r.collapse(true);
                      return r;
                    })() : null);

      if (!range) return;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // NAV
    // =========================
    function show(view){
      const isVideos = view === "videos";
      $("viewVideos").style.display = isVideos ? "" : "none";
      $("viewNotes").style.display = isVideos ? "none" : "";
      $("tabVideos").classList.toggle("active", isVideos);
      $("tabNotes").classList.toggle("active", !isVideos);
    }
    $("tabVideos").onclick = () => show("videos");
    $("tabNotes").onclick = () => show("notes");

    // =========================
    // INIT
    // =========================
    (async function init(){
      loadNotesLocal();
      renderNoteList();
      setActiveNote(activeNoteId);

      await checkApi();
      await loadVideos();
    })();
  </script>
</body>
</html>
