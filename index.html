<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSE</title>
  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --danger: #ff4d6d;
      --ok: #2ee59d;
      --glow: 0 18px 60px rgba(124,77,255,.18);
      --radius: 18px;
      --radius2: 22px;
      --blur: 18px;
      --shadow: 0 12px 50px rgba(0,0,0,.55);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 30% -10%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(800px 600px at 75% 15%, rgba(0,200,255,.14), transparent 60%),
        radial-gradient(900px 700px at 60% 95%, rgba(46,229,157,.10), transparent 65%),
        var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }

    .wrap{max-width:1400px;margin:0 auto;padding:26px 22px 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius:999px; box-shadow: var(--glow);
      backdrop-filter: blur(var(--blur));
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:250px;
    }
    .pill{
      padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok);box-shadow:0 0 18px rgba(46,229,157,.4)}
    .dot.bad{background:var(--danger);box-shadow:0 0 18px rgba(255,77,109,.4)}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:rgba(124,77,255,.22);border-color:rgba(124,77,255,.35)}
    .btn.danger{background:rgba(255,77,109,.12);border-color:rgba(255,77,109,.28)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:18px;
      margin-top:18px;
      align-items:start;
    }

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:650;letter-spacing:.2px;
    }
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .body{padding:14px 16px}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      transition:border-color .2s ease, background .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,77,255,.45);
      background:rgba(0,0,0,.30);
    }
    textarea{min-height:110px;resize:vertical}

    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .hint{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.35}

    .videosTop{
      padding:12px 14px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .search{
      flex:1;
      min-width:280px;
      position:relative;
    }
    .search input{padding-left:38px}
    .search .icon{
      position:absolute;left:12px;top:50%;transform:translateY(-50%);
      opacity:.65;font-size:14px;
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px;cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .chip.active{color:var(--text);background:rgba(124,77,255,.22);border-color:rgba(124,77,255,.35)}
    .chip.drop-target{border-color: rgba(46,229,157,.7); box-shadow: 0 0 0 4px rgba(46,229,157,.12)}
    .count{
      padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);color:var(--text);font-size:12px
    }

    .viewTog{display:flex;gap:8px;align-items:center;margin-left:auto}
    .toggle{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;
      cursor:pointer; user-select:none;
    }
    .toggle.active{background:rgba(46,229,157,.10);color:var(--text);border-color:rgba(46,229,157,.25)}

    .videosBody{padding:14px 16px}
    .gridVideos{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:14px;
    }

    .vcard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:18px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
      transition: transform .16s ease, border-color .2s ease, background .2s ease;
    }
    .vcard:hover{
      transform: translateY(-2px);
      border-color: rgba(124,77,255,.35);
      background:rgba(0,0,0,.26);
    }

    .thumb{
      position:relative;
      aspect-ratio: 16 / 9;
      background: radial-gradient(600px 240px at 30% 20%, rgba(124,77,255,.20), rgba(0,0,0,.45)),
                  linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      display:flex;align-items:center;justify-content:center;
    }
    .thumb video{
      width:100%;height:100%;object-fit:cover;display:none;
    }
    .thumb .play{
      width:54px;height:54px;border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 18px 35px rgba(0,0,0,.45);
      transition: transform .16s ease, opacity .16s ease;
      opacity:.92;
    }
    .vcard:hover .thumb .play{transform:scale(1.03);opacity:1}
    .thumb .play:before{
      content:"‚ñ∂";
      font-size:18px;
      margin-left:3px;
      opacity:.92;
    }

    .meta{
      padding:10px 12px 12px;
      display:grid;gap:6px;
    }
    .meta .t{
      font-weight:650;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .meta .s{
      color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
    }

    .selectBox{
      position:absolute;left:10px;top:10px;
      width:18px;height:18px;border-radius:6px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;justify-content:center;
    }
    .selectBox.on{background:rgba(46,229,157,.16);border-color:rgba(46,229,157,.30)}
    .selectBox.on:before{content:"‚úì";font-size:12px}
    .vcard.selectable .selectBox{display:flex}

    .folderGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:14px;
      margin-bottom:14px;
    }
    .folderTile{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:18px;
      padding:14px;
      display:flex;flex-direction:column;gap:10px;
      transition: transform .16s ease, border-color .2s ease, background .2s ease;
      cursor:pointer;
      user-select:none;
    }
    .folderTile:hover{transform:translateY(-2px);border-color:rgba(124,77,255,.35);background:rgba(0,0,0,.26)}
    .folderTile.drop-target{border-color: rgba(46,229,157,.7); box-shadow: 0 0 0 4px rgba(46,229,157,.12)}
    .folderName{font-weight:700}
    .folderCount{color:var(--muted);font-size:12px}

    .toastWrap{
      position:fixed;right:18px;bottom:18px;
      display:flex;flex-direction:column;gap:10px;z-index:50;
    }
    .toast{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,14,25,.80);
      backdrop-filter: blur(16px);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
      min-width: 260px;
      transform: translateY(8px);
      opacity:0;
      animation: pop .18s ease forwards;
    }
    @keyframes pop { to { transform: translateY(0); opacity:1 } }

    .modal{
      position:fixed;inset:0;z-index:60;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);
      padding:18px;
    }
    .modal.open{display:flex}
    .modalCard{
      width:min(980px, 100%);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      background:rgba(10,14,25,.82);
      box-shadow: 0 20px 70px rgba(0,0,0,.65);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }
    .modalHd{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalBody{padding:14px 16px}
    .modalGrid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px}
    .playerWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      background:#000;
      position:relative;
    }
    video#player{width:100%;height:auto;display:block}
    .modalTools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .k{font-family:var(--mono);font-size:12px;color:var(--muted)}

    .bibleCard .body{padding:12px 16px}
    .bibleRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .bibleRow input{max-width:260px}
    .bibleText{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.22);
      padding:12px;
      color:rgba(255,255,255,.86);
      line-height:1.5;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .muted{color:var(--muted)}
    .err{color:var(--danger);font-size:12px;margin-top:8px;white-space:pre-wrap}
    .oktxt{color:var(--ok);font-size:12px;margin-top:8px}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .modalGrid{grid-template-columns:1fr}
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div style="font-weight:800;letter-spacing:.6px">TSE</div>
        <div class="pill">Videos + Notes ‚Ä¢ Shared via Cloudflare (R2 + D1)</div>
      </div>

      <div class="pill" id="apiPill" style="display:flex;align-items:center;gap:10px">
        <span class="dot bad" id="apiDot"></span>
        <span id="apiText">API: checking‚Ä¶</span>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" id="openApiBtn">Open API</button>
        <button class="btn" id="checkBtn">Check API</button>
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Upload -->
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Upload video</div>
            <div class="sub">Shared ‚Äî appears for everyone using this site</div>
          </div>
          <div class="pill">Max 500MB</div>
        </div>
        <div class="body">
          <label>Video file</label>
          <input type="file" id="file" accept="video/*" />

          <label>Title</label>
          <input id="title" placeholder="e.g., NQ Scalps ‚Äî Jan 4" />

          <div class="row">
            <div>
              <label>Owner</label>
              <input id="owner" placeholder="Aiden" />
            </div>
            <div>
              <label>Sort tag</label>
              <input id="tag" placeholder="Trade Review / Setups / etc" />
            </div>
          </div>

          <label>Description Q1</label>
          <input id="q1" placeholder="What was the setup?" />

          <label>Description Q2</label>
          <input id="q2" placeholder="What did you learn?" />

          <label>Notes (optional)</label>
          <textarea id="notes" placeholder="Write notes attached to this video‚Ä¶"></textarea>

          <label>Folder</label>
          <input id="folder" placeholder="Unsorted" />

          <div class="actions">
            <button class="btn primary" id="uploadBtn">Upload</button>
            <button class="btn" id="clearBtn">Clear</button>
          </div>

          <div class="hint">
            Tip: Drag any video card into a folder chip or folder tile. Press <span class="k">/</span> to focus search. Press <span class="k">Esc</span> to close the player.
          </div>

          <div class="err" id="uploadErr" style="display:none"></div>
          <div class="oktxt" id="uploadOk" style="display:none"></div>
        </div>
      </div>

      <!-- RIGHT: Videos -->
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Videos</div>
            <div class="sub">YouTube-style cards ‚Ä¢ hover preview ‚Ä¢ drag into folders</div>
          </div>
          <button class="btn" id="loadBtn">Load</button>
        </div>

        <div class="videosTop">
          <div class="search">
            <div class="icon">‚åï</div>
            <input id="search" placeholder="Search videos by title, owner, tag, notes‚Ä¶" />
          </div>

          <div class="chip" id="autoLoadChip" title="Auto-refresh list after upload/load">
            <input type="checkbox" id="autoLoad" style="width:auto;margin:0" />
            <span>Auto-load</span>
          </div>

          <div class="pill" id="countPill">0 items</div>

          <div class="viewTog">
            <div class="toggle active" id="viewAll">All</div>
            <div class="toggle" id="viewFolders">Folder view</div>
            <button class="btn" id="selectBtn">Select</button>
            <button class="btn" id="moveBtn" disabled>Move to‚Ä¶</button>
            <button class="btn" id="newFolderBtn">+ Folder</button>
          </div>

          <div class="err" id="loadErr" style="display:none;flex-basis:100%"></div>

          <div class="chips" id="folderChips" style="flex-basis:100%"></div>
        </div>

        <div class="videosBody">
          <div id="folderGrid" class="folderGrid" style="display:none"></div>
          <div id="videosGrid" class="gridVideos"></div>
        </div>
      </div>
    </div>

    <!-- Bible Study -->
    <div class="card bibleCard" style="margin-top:18px">
      <div class="hd">
        <div>
          <div class="title">Daily Bible Study</div>
          <div class="sub">Pull a verse + write a daily journal (saved in D1)</div>
        </div>
        <div class="pill" id="bibleStatus">Ready</div>
      </div>
      <div class="body">
        <div class="bibleRow">
          <label style="margin:0">Date</label>
          <input id="bibleDate" type="date" />
          <label style="margin:0">Reference</label>
          <input id="bibleRef" placeholder="John 3:16" />
          <button class="btn" id="bibleFetchBtn">Fetch</button>
          <button class="btn" id="bibleLoadJournalBtn">Load journal</button>
          <button class="btn primary" id="bibleSaveJournalBtn">Save journal</button>
        </div>

        <div class="bibleText" id="bibleText">Pick a verse and hit Fetch.</div>

        <label>Journal (saved per day)</label>
        <textarea id="bibleJournal" placeholder="What stood out? How will you apply it today?"></textarea>

        <div class="err" id="bibleErr" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Player / Editor Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalHd">
        <div>
          <div class="title" id="mTitle">Video</div>
          <div class="sub" id="mSub">‚Äî</div>
        </div>
        <div class="modalTools">
          <button class="btn" id="copyLinkBtn">Copy stream link</button>
          <button class="btn" id="openStreamBtn">Open stream</button>
          <button class="btn danger" id="deleteBtn">Delete</button>
          <button class="btn" id="closeBtn">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="modalGrid">
          <div>
            <div class="playerWrap">
              <video id="player" controls playsinline></video>
            </div>
          </div>
          <div>
            <div class="card" style="box-shadow:none">
              <div class="hd">
                <div class="title">Notes</div>
                <button class="btn primary" id="saveNotesBtn">Save</button>
              </div>
              <div class="body">
                <label>Title</label>
                <input id="mTitleInput" />
                <div class="row">
                  <div>
                    <label>Owner</label>
                    <input id="mOwner" />
                  </div>
                  <div>
                    <label>Tag</label>
                    <input id="mTag" />
                  </div>
                </div>

                <label>Q1</label>
                <input id="mQ1" />
                <label>Q2</label>
                <input id="mQ2" />

                <label>Folder</label>
                <input id="mFolder" />

                <label>Notes</label>
                <textarea id="mNotes"></textarea>

                <div class="hint">
                  Drag & drop also works: drop this video onto a folder chip/tile to move instantly.
                </div>
                <div class="err" id="mErr" style="display:none"></div>
                <div class="oktxt" id="mOk" style="display:none"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Move Modal -->
  <div class="modal" id="moveModal">
    <div class="modalCard" style="width:min(560px,100%)">
      <div class="modalHd">
        <div>
          <div class="title">Move selected</div>
          <div class="sub" id="moveSub">0 selected</div>
        </div>
        <button class="btn" id="moveClose">Close</button>
      </div>
      <div class="modalBody">
        <label>Folder</label>
        <input id="moveFolder" placeholder="Unsorted" />
        <div class="actions">
          <button class="btn primary" id="moveConfirm">Move</button>
        </div>
        <div class="hint muted">Tip: You can also drag selected cards onto a folder tile.</div>
        <div class="err" id="moveErr" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- New Folder Modal -->
  <div class="modal" id="folderModal">
    <div class="modalCard" style="width:min(520px,100%)">
      <div class="modalHd">
        <div>
          <div class="title">Create folder</div>
          <div class="sub">Folders are saved in D1</div>
        </div>
        <button class="btn" id="folderClose">Close</button>
      </div>
      <div class="modalBody">
        <label>Name</label>
        <input id="folderName" placeholder="Fair Value Gaps" />
        <div class="actions">
          <button class="btn primary" id="folderCreate">Create</button>
        </div>
        <div class="err" id="folderErr" style="display:none"></div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toasts"></div>

  <script>
    // ========= Config =========
    const API_BASE = "https://api.tseapp.com";
    const $ = (id) => document.getElementById(id);

    // ========= UI helpers =========
    function toast(msg){
      const wrap = $("toasts");
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity = "0"; t.style.transform = "translateY(10px)"; }, 2200);
      setTimeout(()=>{ t.remove(); }, 2600);
    }

    function showErr(el, msg){
      el.style.display = "block";
      el.textContent = msg;
    }
    function hideErr(el){ el.style.display = "none"; el.textContent=""; }

    function fmtTime(sec){
      if (!sec) return "";
      const d = new Date(sec * 1000);
      return d.toLocaleString();
    }

    async function api(path, opts={}){
      const url = API_BASE + path;
      const res = await fetch(url, opts);
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch(_){ data = { raw:text }; }
      if (!res.ok) throw new Error((data && (data.error || data.details)) ? JSON.stringify(data) : text);
      return data;
    }

    // ========= State =========
    let videos = [];
    let folders = [];
    let activeFolder = "all";
    let viewMode = "all"; // all | folders
    let selecting = false;
    const selected = new Set();
    let modalVideo = null;

    // ========= API Status =========
    async function checkApi(){
      const dot = $("apiDot"), text = $("apiText");
      try{
        const d = await api("/api/health");
        dot.className = "dot ok";
        text.textContent = "API: online";
        return d;
      }catch(e){
        dot.className = "dot bad";
        text.textContent = "API: offline";
        return null;
      }
    }

    // ========= Load folders/videos =========
    async function loadFolders(){
      const d = await api("/api/folders");
      folders = (d.folders || []).map(f => f.name);
      if (!folders.includes("Unsorted")) folders.unshift("Unsorted");
      renderFolderChips();
      renderFolderTiles();
    }

    function getFilteredVideos(){
      const q = $("search").value.trim().toLowerCase();
      return videos.filter(v => {
        const folder = (v.folder || "Unsorted");
        if (activeFolder !== "all" && folder !== activeFolder) return false;
        if (!q) return true;
        const blob = [
          v.title, v.owner, v.tag, v.q1, v.q2, v.notes, v.folder
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    async function loadVideos(){
      hideErr($("loadErr"));
      try{
        const d = await api("/api/videos");
        videos = d.videos || [];
        $("countPill").textContent = `${videos.length} items`;
        render();
      }catch(e){
        showErr($("loadErr"), `Load failed: ${e.message}`);
      }
    }

    // ========= Rendering =========
    function render(){
      const list = getFilteredVideos();
      $("countPill").textContent = `${list.length} items`;
      renderFolderChipsCounts();
      if (viewMode === "folders"){
        $("folderGrid").style.display = "grid";
      } else {
        $("folderGrid").style.display = "none";
      }
      renderFolderTiles();
      renderVideos(list);
    }

    function renderFolderChips(){
      const wrap = $("folderChips");
      wrap.innerHTML = "";

      // All
      const all = document.createElement("div");
      all.className = "chip " + (activeFolder === "all" ? "active" : "");
      all.innerHTML = `All <span class="count">${videos.length}</span>`;
      all.onclick = () => { activeFolder = "all"; render(); };
      setDropTargetBehavior(all, "all");
      wrap.appendChild(all);

      // Folder chips
      for (const f of folders){
        const chip = document.createElement("div");
        chip.className = "chip " + (activeFolder === f ? "active" : "");
        const c = videos.filter(v => (v.folder||"Unsorted") === f).length;
        chip.innerHTML = `${escapeHtml(f)} <span class="count">${c}</span>`;
        chip.onclick = () => { activeFolder = f; render(); };
        setDropTargetBehavior(chip, f);
        wrap.appendChild(chip);
      }
    }

    function renderFolderChipsCounts(){
      // Re-render chips quickly so counts stay accurate
      renderFolderChips();
    }

    function renderFolderTiles(){
      const grid = $("folderGrid");
      if (viewMode !== "folders"){
        grid.innerHTML = "";
        return;
      }
      grid.innerHTML = "";
      const allFolders = ["Unsorted", ...folders.filter(f => f !== "Unsorted")];

      for (const f of allFolders){
        const tile = document.createElement("div");
        tile.className = "folderTile";
        const c = videos.filter(v => (v.folder||"Unsorted") === f).length;
        tile.innerHTML = `
          <div class="folderName">üìÅ ${escapeHtml(f)}</div>
          <div class="folderCount">${c} video${c===1?"":"s"}</div>
          <div class="muted" style="font-size:12px">Drop videos here</div>
        `;
        tile.onclick = () => { activeFolder = f; $("viewAll").click(); render(); };
        setDropTargetBehavior(tile, f);
        grid.appendChild(tile);
      }
    }

    function renderVideos(list){
      const grid = $("videosGrid");
      grid.innerHTML = "";

      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "pill";
        empty.style.width = "100%";
        empty.textContent = "No videos ‚Äî upload one, then click Load (or enable Auto-load).";
        grid.appendChild(empty);
        return;
      }

      for (const v of list){
        const card = document.createElement("div");
        card.className = "vcard" + (selecting ? " selectable" : "");
        card.dataset.id = v.id;

        const folder = v.folder || "Unsorted";
        const owner = v.owner || "No owner";
        const tag = v.tag || "No tag";

        card.innerHTML = `
          <div class="thumb">
            <video muted playsinline preload="none"></video>
            <div class="play"></div>
          </div>
          <div class="selectBox ${selected.has(v.id) ? "on" : ""}"></div>
          <div class="meta">
            <div class="t">${escapeHtml(v.title || "(untitled)")}</div>
            <div class="s">
              <span class="badge">${escapeHtml(owner)}</span>
              <span class="badge">${escapeHtml(tag)}</span>
              <span class="badge">üìÅ ${escapeHtml(folder)}</span>
            </div>
            <div class="s muted">${fmtTime(v.createdAt)} ‚Ä¢ ${escapeHtml(v.id.slice(0,7))}</div>
          </div>
        `;

        // Hover preview
        const vid = card.querySelector("video");
        let hoverTimer = null;
        card.addEventListener("mouseenter", () => {
          if (selecting) return;
          hoverTimer = setTimeout(() => {
            vid.src = `${API_BASE}/api/videos/${encodeURIComponent(v.id)}/stream`;
            vid.style.display = "block";
            vid.currentTime = 0;
            vid.play().catch(()=>{});
          }, 250);
        });
        card.addEventListener("mouseleave", () => {
          if (hoverTimer) clearTimeout(hoverTimer);
          try { vid.pause(); } catch(_){}
          vid.removeAttribute("src");
          vid.load();
          vid.style.display = "none";
        });

        // Click behavior
        card.onclick = (e) => {
          if (selecting){
            toggleSelect(v.id);
            card.querySelector(".selectBox").classList.toggle("on", selected.has(v.id));
            return;
          }
          openModal(v);
        };

        // Drag behavior
        card.draggable = true;
        card.addEventListener("dragstart", (e) => {
          const ids = selecting && selected.size ? Array.from(selected) : [v.id];
          e.dataTransfer.setData("text/plain", JSON.stringify({ ids }));
          e.dataTransfer.effectAllowed = "move";
          toast(`Dragging ${ids.length} video${ids.length===1?"":"s"}‚Ä¶`);
        });

        grid.appendChild(card);
      }
    }

    function toggleSelect(id){
      if (selected.has(id)) selected.delete(id);
      else selected.add(id);
      $("moveBtn").disabled = selected.size === 0;
      $("moveSub").textContent = `${selected.size} selected`;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========= Drag & drop to folders =========
    function setDropTargetBehavior(el, folderName){
      const onEnter = (e) => {
        e.preventDefault();
        el.classList.add("drop-target");
      };
      const onOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      };
      const onLeave = () => el.classList.remove("drop-target");
      const onDrop = async (e) => {
        e.preventDefault();
        el.classList.remove("drop-target");
        const raw = e.dataTransfer.getData("text/plain");
        let payload = null;
        try{ payload = JSON.parse(raw); }catch(_){}
        const ids = payload?.ids || [];
        if (!ids.length) return;

        const folder = folderName === "all" ? "Unsorted" : folderName;
        await assignFolder(ids, folder);
      };

      el.addEventListener("dragenter", onEnter);
      el.addEventListener("dragover", onOver);
      el.addEventListener("dragleave", onLeave);
      el.addEventListener("drop", onDrop);
    }

    async function assignFolder(ids, folder){
      try{
        await api("/api/folders/assign", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ ids, folder })
        });
        toast(`Moved ${ids.length} ‚Üí ${folder}`);
        // local update
        for (const v of videos){
          if (ids.includes(v.id)) v.folder = folder;
        }
        selected.clear();
        $("moveBtn").disabled = true;
        render();
      }catch(e){
        toast("Move failed");
        showErr($("loadErr"), `Move failed: ${e.message}`);
      }
    }

    // ========= Modal =========
    function openModal(v){
      modalVideo = v;
      $("modal").classList.add("open");

      $("mTitle").textContent = v.title || "(untitled)";
      $("mSub").textContent = `${v.owner || "No owner"} ‚Ä¢ ${v.tag || "No tag"} ‚Ä¢ ${fmtTime(v.createdAt)}`;

      $("player").src = `${API_BASE}/api/videos/${encodeURIComponent(v.id)}/stream`;

      $("mTitleInput").value = v.title || "";
      $("mOwner").value = v.owner || "";
      $("mTag").value = v.tag || "";
      $("mQ1").value = v.q1 || "";
      $("mQ2").value = v.q2 || "";
      $("mNotes").value = v.notes || "";
      $("mFolder").value = v.folder || "Unsorted";

      hideErr($("mErr")); $("mOk").style.display="none";
    }

    function closeModal(){
      $("modal").classList.remove("open");
      const p = $("player");
      try{ p.pause(); }catch(_){}
      p.removeAttribute("src");
      p.load();
      modalVideo = null;
    }

    async function saveModal(){
      if (!modalVideo) return;
      hideErr($("mErr")); $("mOk").style.display="none";

      const body = {
        title: $("mTitleInput").value,
        owner: $("mOwner").value,
        tag: $("mTag").value,
        q1: $("mQ1").value,
        q2: $("mQ2").value,
        notes: $("mNotes").value,
        folder: $("mFolder").value
      };

      try{
        await api(`/api/videos/${encodeURIComponent(modalVideo.id)}`,{
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });

        // update local
        Object.assign(modalVideo, body, { folder: body.folder || "Unsorted" });
        $("mOk").style.display="block";
        $("mOk").textContent = "Saved ‚úì";
        toast("Saved");
        render();
      }catch(e){
        showErr($("mErr"), `Save failed: ${e.message}`);
      }
    }

    async function deleteModal(){
      if (!modalVideo) return;
      if (!confirm("Delete this video? This removes it from D1 and R2.")) return;

      try{
        await api(`/api/videos/${encodeURIComponent(modalVideo.id)}`, { method:"DELETE" });
        toast("Deleted");
        videos = videos.filter(x => x.id !== modalVideo.id);
        closeModal();
        render();
      }catch(e){
        showErr($("mErr"), `Delete failed: ${e.message}`);
      }
    }

    // ========= Upload =========
    function clearUpload(){
      $("file").value = "";
      $("title").value = "";
      $("owner").value = "";
      $("tag").value = "";
      $("q1").value = "";
      $("q2").value = "";
      $("notes").value = "";
      $("folder").value = "";
      hideErr($("uploadErr"));
      $("uploadOk").style.display="none";
    }

    async function doUpload(){
      hideErr($("uploadErr"));
      $("uploadOk").style.display="none";
      const f = $("file").files?.[0];
      if (!f) return showErr($("uploadErr"), "Pick a video file first.");

      const fd = new FormData();
      fd.append("file", f);
      fd.append("title", $("title").value);
      fd.append("owner", $("owner").value);
      fd.append("tag", $("tag").value);
      fd.append("q1", $("q1").value);
      fd.append("q2", $("q2").value);
      fd.append("notes", $("notes").value);
      fd.append("folder", $("folder").value || "Unsorted");

      $("uploadBtn").disabled = true;
      $("uploadBtn").textContent = "Uploading‚Ä¶";

      try{
        await api("/api/videos/upload", { method:"POST", body: fd });
        $("uploadOk").style.display="block";
        $("uploadOk").textContent = "Upload complete ‚úì";
        toast("Upload complete");
        clearUpload();

        if ($("autoLoad").checked){
          await loadFolders();
          await loadVideos();
        }
      }catch(e){
        showErr($("uploadErr"), `Upload failed: ${e.message}`);
      }finally{
        $("uploadBtn").disabled = false;
        $("uploadBtn").textContent = "Upload";
      }
    }

    // ========= Folder create =========
    function openFolderModal(){
      $("folderModal").classList.add("open");
      $("folderName").value = "";
      hideErr($("folderErr"));
      setTimeout(()=> $("folderName").focus(), 0);
    }
    function closeFolderModal(){ $("folderModal").classList.remove("open"); }
    async function createFolder(){
      hideErr($("folderErr"));
      const name = $("folderName").value.trim();
      if (!name) return showErr($("folderErr"), "Folder name required.");

      try{
        await api("/api/folders",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name })
        });
        toast("Folder created");
        closeFolderModal();
        await loadFolders();
        render();
      }catch(e){
        showErr($("folderErr"), `Create failed: ${e.message}`);
      }
    }

    // ========= Select + Move =========
    function toggleSelecting(){
      selecting = !selecting;
      if (!selecting) selected.clear();
      $("selectBtn").textContent = selecting ? "Done" : "Select";
      $("moveBtn").disabled = selected.size === 0;
      render();
    }

    function openMoveModal(){
      $("moveModal").classList.add("open");
      $("moveSub").textContent = `${selected.size} selected`;
      $("moveFolder").value = activeFolder === "all" ? "Unsorted" : activeFolder;
      hideErr($("moveErr"));
    }
    function closeMoveModal(){ $("moveModal").classList.remove("open"); }
    async function confirmMove(){
      hideErr($("moveErr"));
      const folder = $("moveFolder").value.trim() || "Unsorted";
      const ids = Array.from(selected);
      if (!ids.length) return closeMoveModal();
      try{
        await assignFolder(ids, folder);
        closeMoveModal();
      }catch(e){
        showErr($("moveErr"), e.message);
      }
    }

    // ========= Bible =========
    function setBibleStatus(msg){ $("bibleStatus").textContent = msg; }
    async function fetchBible(){
      hideErr($("bibleErr"));
      const date = $("bibleDate").value || new Date().toISOString().slice(0,10);
      const ref = $("bibleRef").value.trim() || "John 3:16";
      setBibleStatus("Fetching‚Ä¶");
      try{
        const d = await api(`/api/bible/daily?date=${encodeURIComponent(date)}&ref=${encodeURIComponent(ref)}`);
        $("bibleText").textContent = `${d.ref} (${d.translation})\n\n${d.text}`.trim();
        setBibleStatus("Ready");
      }catch(e){
        setBibleStatus("Error");
        showErr($("bibleErr"), `Bible fetch failed: ${e.message}`);
      }
    }
    async function loadJournal(){
      hideErr($("bibleErr"));
      const date = $("bibleDate").value || new Date().toISOString().slice(0,10);
      setBibleStatus("Loading journal‚Ä¶");
      try{
        const d = await api(`/api/bible/journal?date=${encodeURIComponent(date)}`);
        $("bibleJournal").value = d.text || "";
        setBibleStatus("Ready");
        toast("Journal loaded");
      }catch(e){
        setBibleStatus("Error");
        showErr($("bibleErr"), `Load journal failed: ${e.message}`);
      }
    }
    async function saveJournal(){
      hideErr($("bibleErr"));
      const date = $("bibleDate").value || new Date().toISOString().slice(0,10);
      const text = $("bibleJournal").value;
      setBibleStatus("Saving‚Ä¶");
      try{
        await api(`/api/bible/journal?date=${encodeURIComponent(date)}`,{
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text })
        });
        setBibleStatus("Saved ‚úì");
        toast("Journal saved");
        setTimeout(()=> setBibleStatus("Ready"), 1100);
      }catch(e){
        setBibleStatus("Error");
        showErr($("bibleErr"), `Save journal failed: ${e.message}`);
      }
    }

    // ========= Events =========
    $("checkBtn").onclick = checkApi;
    $("refreshBtn").onclick = async () => { await loadFolders(); await loadVideos(); };
    $("loadBtn").onclick = async () => { await loadFolders(); await loadVideos(); };

    $("openApiBtn").onclick = () => window.open(API_BASE + "/api/health", "_blank");

    $("uploadBtn").onclick = doUpload;
    $("clearBtn").onclick = clearUpload;

    $("search").addEventListener("input", () => render());
    window.addEventListener("keydown", (e) => {
      if (e.key === "/"){
        e.preventDefault();
        $("search").focus();
      }
      if (e.key === "Escape"){
        closeModal();
        closeMoveModal();
        closeFolderModal();
      }
    });

    $("closeBtn").onclick = closeModal;
    $("saveNotesBtn").onclick = saveModal;
    $("deleteBtn").onclick = deleteModal;

    $("copyLinkBtn").onclick = async () => {
      if (!modalVideo) return;
      const link = `${API_BASE}/api/videos/${encodeURIComponent(modalVideo.id)}/stream`;
      await navigator.clipboard.writeText(link).catch(()=>{});
      toast("Stream link copied");
    };
    $("openStreamBtn").onclick = () => {
      if (!modalVideo) return;
      const link = `${API_BASE}/api/videos/${encodeURIComponent(modalVideo.id)}/stream`;
      window.open(link, "_blank");
    };

    $("newFolderBtn").onclick = openFolderModal;
    $("folderClose").onclick = closeFolderModal;
    $("folderCreate").onclick = createFolder;

    $("selectBtn").onclick = toggleSelecting;
    $("moveBtn").onclick = openMoveModal;
    $("moveClose").onclick = closeMoveModal;
    $("moveConfirm").onclick = confirmMove;

    $("viewAll").onclick = () => {
      viewMode = "all";
      $("viewAll").classList.add("active");
      $("viewFolders").classList.remove("active");
      render();
    };
    $("viewFolders").onclick = () => {
      viewMode = "folders";
      $("viewFolders").classList.add("active");
      $("viewAll").classList.remove("active");
      render();
    };

    $("autoLoadChip").onclick = (e) => {
      if (e.target && e.target.id === "autoLoad") return;
      $("autoLoad").checked = !$("autoLoad").checked;
    };

    $("bibleDate").value = new Date().toISOString().slice(0,10);
    $("bibleRef").value = "John 3:16";
    $("bibleFetchBtn").onclick = fetchBible;
    $("bibleLoadJournalBtn").onclick = loadJournal;
    $("bibleSaveJournalBtn").onclick = saveJournal;

    // ========= Boot =========
    (async function init(){
      await checkApi();
      try{
        await loadFolders();
        await loadVideos();
      }catch(_){}
      // pleasant first-run
      setTimeout(()=>toast("Tip: hover a card to preview"), 800);
      setTimeout(()=>toast("Drag videos into folders"), 1600);
    })();
  </script>
</body>
</html>
